<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Javaå¤šçº¿ç¨‹ - hbprotossçš„åšå®¢</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="hbprotoss" />
  <meta name="description" content="é›¶æ•£ç¬”è®°çš„æµæ°´è´¦å¼æ€»ç»“ï¼Œæœ‰é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£ğŸ˜‚ éƒ¨åˆ†å›¾ç‰‡èµ„æºæ¥è‡ªç½‘ç»œï¼Œä¾µåˆ  1. å†…å­˜æ¨¡å‹ 1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹ CPUä¸èƒ½ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å°†å†…å­˜ä¸­çš„å€¼è¯»" />

  <meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.46" />


<link rel="canonical" href="http://hbprotoss.github.io/post/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%80%BB%E7%BB%93/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="Javaå¤šçº¿ç¨‹" />
<meta property="og:description" content="é›¶æ•£ç¬”è®°çš„æµæ°´è´¦å¼æ€»ç»“ï¼Œæœ‰é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£ğŸ˜‚ éƒ¨åˆ†å›¾ç‰‡èµ„æºæ¥è‡ªç½‘ç»œï¼Œä¾µåˆ  1. å†…å­˜æ¨¡å‹ 1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹ CPUä¸èƒ½ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å°†å†…å­˜ä¸­çš„å€¼è¯»" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hbprotoss.github.io/post/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%80%BB%E7%BB%93/" />



<meta property="article:published_time" content="2018-09-27T09:51:48&#43;08:00"/>

<meta property="article:modified_time" content="2018-09-27T09:51:48&#43;08:00"/>











<meta itemprop="name" content="Javaå¤šçº¿ç¨‹">
<meta itemprop="description" content="é›¶æ•£ç¬”è®°çš„æµæ°´è´¦å¼æ€»ç»“ï¼Œæœ‰é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£ğŸ˜‚ éƒ¨åˆ†å›¾ç‰‡èµ„æºæ¥è‡ªç½‘ç»œï¼Œä¾µåˆ  1. å†…å­˜æ¨¡å‹ 1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹ CPUä¸èƒ½ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å°†å†…å­˜ä¸­çš„å€¼è¯»">


<meta itemprop="datePublished" content="2018-09-27T09:51:48&#43;08:00" />
<meta itemprop="dateModified" content="2018-09-27T09:51:48&#43;08:00" />
<meta itemprop="wordCount" content="7240">



<meta itemprop="keywords" content="Java,Concurrent," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Javaå¤šçº¿ç¨‹"/>
<meta name="twitter:description" content="é›¶æ•£ç¬”è®°çš„æµæ°´è´¦å¼æ€»ç»“ï¼Œæœ‰é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£ğŸ˜‚ éƒ¨åˆ†å›¾ç‰‡èµ„æºæ¥è‡ªç½‘ç»œï¼Œä¾µåˆ  1. å†…å­˜æ¨¡å‹ 1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹ CPUä¸èƒ½ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å°†å†…å­˜ä¸­çš„å€¼è¯»"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">hbprotossçš„åšå®¢</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">hbprotossçš„åšå®¢</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Javaå¤šçº¿ç¨‹</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-09-27 </span>
        
        <span class="more-meta"> 7240 words </span>
        <span class="more-meta"> 15 mins read </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#1-å†…å­˜æ¨¡å‹">1. å†…å­˜æ¨¡å‹</a>
<ul>
<li><a href="#1-1-ç¡¬ä»¶å†…å­˜æ¨¡å‹">1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹</a></li>
<li><a href="#1-2-jvmå†…å­˜æ¨¡å‹">1.2 JVMå†…å­˜æ¨¡å‹</a>
<ul>
<li><a href="#1-2-1-çº¿ç¨‹æ ˆ">1.2.1 çº¿ç¨‹æ ˆ</a></li>
<li><a href="#1-2-2-å †">1.2.2 å †</a></li>
</ul></li>
</ul></li>
<li><a href="#2-volatileå…³é”®å­—">2. volatileå…³é”®å­—</a>
<ul>
<li><a href="#2-1-å˜é‡å¯è§æ€§">2.1 å˜é‡å¯è§æ€§</a></li>
<li><a href="#2-2-ä¹±åºæ‰§è¡Œ">2.2 ä¹±åºæ‰§è¡Œ</a></li>
<li><a href="#2-3-volatileä¸æ˜¯ä»€ä¹ˆ">2.3 volatileä¸æ˜¯ä»€ä¹ˆ</a></li>
</ul></li>
<li><a href="#3-synchronizedå…³é”®å­—-monitor">3. synchronizedå…³é”®å­—(Monitor)</a></li>
<li><a href="#4-lock">4. Lock</a>
<ul>
<li><a href="#4-1-å¸¸è§çš„lock">4.1 å¸¸è§çš„Lock</a>
<ul>
<li><a href="#4-1-1-reentrantlock">4.1.1 ReentrantLock</a></li>
<li><a href="#4-1-2-readwritelock-interface">4.1.2 ReadWriteLock(interface)</a></li>
<li><a href="#4-1-3-reentrantreadwritelock">4.1.3 ReentrantReadWriteLock</a></li>
</ul></li>
<li><a href="#4-2-lockå®ç°">4.2 Lockå®ç°</a>
<ul>
<li><a href="#4-2-1-é€šç”¨å®ç°">4.2.1 é€šç”¨å®ç°</a>
<ul>
<li><a href="#aqs">AQS</a></li>
<li><a href="#è·å¾—é”">è·å¾—é”</a></li>
<li><a href="#é‡Šæ”¾é”">é‡Šæ”¾é”</a></li>
</ul></li>
<li><a href="#4-2-2-reentrantlockå®ç°">4.2.2 ReentrantLockå®ç°</a>
<ul>
<li><a href="#nonfairsync">NonfairSync</a></li>
<li><a href="#fairsync">FairSync</a></li>
</ul></li>
<li><a href="#4-2-3-reentrantreadwritelockå®ç°">4.2.3 ReentrantReadWriteLockå®ç°</a>
<ul>
<li><a href="#nonfairsync-fairsync">NonfairSync &amp; FairSync</a></li>
</ul></li>
</ul></li>
<li><a href="#4-3-conditionå®ç°">4.3 Conditionå®ç°</a>
<ul>
<li><a href="#4-3-1-await">4.3.1 await</a></li>
<li><a href="#4-3-2-signal">4.3.2 signal</a></li>
</ul></li>
</ul></li>
<li><a href="#5-lock-free">5. Lock Free</a></li>
<li><a href="#6-å¸¸ç”¨åŒæ­¥å·¥å…·">6. å¸¸ç”¨åŒæ­¥å·¥å…·</a>
<ul>
<li><a href="#countdownlatch">CountDownLatch</a></li>
<li><a href="#semaphore">Semaphore</a></li>
<li><a href="#cyclicbarrier">CyclicBarrier</a></li>
</ul></li>
<li><a href="#7-çº¿ç¨‹æ± ">7. çº¿ç¨‹æ± </a>
<ul>
<li><a href="#ä½¿ç”¨">ä½¿ç”¨</a></li>
<li><a href="#å®ç°">å®ç°</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<p>é›¶æ•£ç¬”è®°çš„æµæ°´è´¦å¼æ€»ç»“ï¼Œæœ‰é”™è¯¯ä¹‹å¤„è¯·æŒ‡æ­£ğŸ˜‚</p>

<p>éƒ¨åˆ†å›¾ç‰‡èµ„æºæ¥è‡ªç½‘ç»œï¼Œä¾µåˆ </p>

<h1 id="1-å†…å­˜æ¨¡å‹">1. å†…å­˜æ¨¡å‹</h1>

<h2 id="1-1-ç¡¬ä»¶å†…å­˜æ¨¡å‹">1.1 ç¡¬ä»¶å†…å­˜æ¨¡å‹</h2>

<p><img src="https://i.imgur.com/vOCieKM.png" alt="Modern hardware memory architecture." /></p>

<p>CPUä¸èƒ½ç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼Œå¿…é¡»å°†å†…å­˜ä¸­çš„å€¼è¯»åˆ°cache/å¯„å­˜å™¨ä¸­è¿›è¡Œæ“ä½œï¼Œç„¶åå†™å›å†…å­˜</p>

<h2 id="1-2-jvmå†…å­˜æ¨¡å‹">1.2 JVMå†…å­˜æ¨¡å‹</h2>

<p><img src="https://i.imgur.com/7kEU2P3.jpg" alt="" /></p>

<p>JVMæ¨¡å‹å’ŒOSçš„å†…å­˜æ¨¡å‹ä¸€æ ·ï¼Œåˆ†æ ˆå’Œå †</p>

<h3 id="1-2-1-çº¿ç¨‹æ ˆ">1.2.1 çº¿ç¨‹æ ˆ</h3>

<p>æ¯ä¸ªçº¿ç¨‹ä¼šåˆ†é…ä¸€ä¸ªçº¿ç¨‹æ ˆï¼Œç”¨äºå­˜å‚¨æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ï¼Œä¸»è¦ç”¨æ¥å­˜å‚¨</p>

<ul>
<li>åŸå§‹ç±»å‹å˜é‡</li>
<li>å †å¯¹è±¡å¼•ç”¨</li>
</ul>

<h3 id="1-2-2-å †">1.2.2 å †</h3>

<p>Javaå¯¹è±¡çš„ä¸»è¦å­˜å‚¨åŒºåŸŸï¼Œnewå‡ºæ¥çš„å¯¹è±¡éƒ½åœ¨å †åŒº</p>

<h1 id="2-volatileå…³é”®å­—">2. volatileå…³é”®å­—</h1>

<h2 id="2-1-å˜é‡å¯è§æ€§">2.1 å˜é‡å¯è§æ€§</h2>

<p>ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å¼•ç”¨å †ä¸­çš„å¯¹è±¡ï¼Œæƒ³ä¿®æ”¹å¯¹è±¡ä¸­æŸä¸ªå­—æ®µçš„å€¼ï¼Œåœ¨é€šè¿‡jvmæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œåˆ°ç¡¬ä»¶å±‚é¢ï¼ŒcpuåŒæ ·éœ€è¦ä»å†…å­˜æŠŠæ•°æ®è¯»åˆ°cacheé‡Œï¼Œæ“ä½œå®Œæˆä¹‹åå†™å›å†…å­˜</p>

<p><code>i=0</code>ç”±äºè¿™ä¸ªç‰¹æ€§ï¼Œåœ¨t1æ‰§è¡Œå®Œ<code>i+=1</code>æ“ä½œåï¼Œcpu cacheä¸­çš„å€¼å¹¶æ²¡æœ‰åŠæ—¶å†™å›å†…å­˜ï¼Œå¯¼è‡´t2åœ¨æ‰§è¡Œ<code>i+=1</code>æ“ä½œæ—¶ï¼Œä»å†…å­˜è¯»åˆ°çš„å€¼ä¾æ—§æ˜¯0ã€‚å’Œæœ€ç»ˆçš„é¢„æœŸå¹¶ä¸ä¸€è‡´</p>

<p><img src="https://i.imgur.com/xIqwPyU.png" alt="image-20180927152138166" /></p>

<p>ç»™å˜é‡åŠ ä¸Švolatileå…³é”®å­—ï¼Œå°±èƒ½ç¡®ä¿å¯¹å˜é‡çš„æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œcpu cacheä¸­çš„å€¼è¢«åŠæ—¶å†™å›å†…å­˜ã€‚</p>

<p>volatileæœ‰ä¸ªé¢å¤–çš„ä¿è¯ï¼Œå½“t1å†™å›ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼Œæ‰€æœ‰å¯¹t1å¯è§çš„å˜é‡éƒ½ä¼šè¢«å†™å›å†…å­˜</p>

<h2 id="2-2-ä¹±åºæ‰§è¡Œ">2.2 ä¹±åºæ‰§è¡Œ</h2>

<p>ä»¥ä¸‹ä»£ç </p>

<pre><code class="language-java">int a = 0;
int b = 0;
a += 1;
b += 1;
</code></pre>

<p>æœ€ç»ˆæ‰§è¡Œæ•ˆæœå¯èƒ½æ˜¯</p>

<pre><code class="language-java">int a = 0;
a += 1;
int b = 0;
b += 1;
</code></pre>

<p>ç¼–è¯‘å™¨/cpuéƒ½å¯èƒ½å¸®ä½ å¹²è¿™ç§äº‹ã€‚ç¼–è¯‘å™¨å…ˆç•¥è¿‡ï¼Œçœ‹çœ‹cpuã€‚</p>

<p>ç°ä»£cpuå†…ç½®äº†è‹¥å¹²æ¡æŒ‡ä»¤æµæ°´çº¿ï¼Œä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„æ—¶å€™ä¼šåˆ†æˆè‹¥å¹²ä¸ªé˜¶æ®µï¼ŒæŸäº›é˜¶æ®µäº’ä¸å½±å“ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼Œæ‰€ä»¥ä¼šè¢«åˆ†é…åˆ°è¿™äº›æµæ°´çº¿é‡Œã€‚å½“é‡åˆ°åˆ†æ”¯æ¡ä»¶æ—¶ï¼Œcpuå¯èƒ½ä¼šè¿›è¡Œåˆ†æ”¯é¢„æµ‹ï¼Œå³åœ¨æµæ°´çº¿é‡ŒåŒæ—¶æ‰§è¡Œä¸¤ä¸ªåˆ†æ”¯æ¡ä»¶ï¼Œå½“å‘½ä¸­å…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ—¶ï¼Œç«‹åˆ»æŠ›å¼ƒæ‰å¦ä¸€ä¸ªåˆ†æ”¯çš„æµæ°´çº¿æŒ‡ä»¤ï¼Œæé«˜æ•ˆç‡ï¼Œåæ­£ç©ºç€ä¹Ÿæ˜¯ç©ºç€ã€‚</p>

<p>ä»cpuè§’åº¦ï¼Œä»¥ä¸Šåšæ³•æ˜¯ä¸ºäº†å‡å°‘æ‰§è¡Œè¿™4æ¡è¯­å¥çš„æ€»æŒ‡ä»¤å‘¨æœŸã€‚å½“cpuå‘ç°ï¼ŒåŸè¯­å¥é¡ºåºé‡Œï¼Œè¯­å¥1/3å’Œè¯­å¥2/4çš„æ‰§è¡Œç›¸äº’ç‹¬ç«‹ï¼Œäº’ä¸å½±å“ï¼Œ2å’Œ3çš„æ‰§è¡Œé¡ºåºå¹¶ä¸ä¼šå½±å“æœ€ç»ˆç»“æœï¼Œcpuå¯èƒ½å°±ä¼šæ‰“ä¹±æŒ‡ä»¤é¡ºåºï¼ŒæŒ‰æœ€ä¼˜é¡ºåºæ‰§è¡Œã€‚</p>

<p>åœ¨ä¸Šé¢è¿™æ®µä»£ç é‡Œï¼Œä¹±åºæ˜¯æ²¡ä»€ä¹ˆæ¯›ç—…ï¼Œæ¯•ç«Ÿç»“æœä¸€æ ·ï¼Œä½†æ˜¯ä¸‹é¢è¿™ä¸€æ®µå¯èƒ½å°±ä¸ä¸€æ ·äº†ã€‚</p>

<p>å¸¸è§çš„double check singleton</p>

<pre><code class="language-java">public class A {
    private static A _instance;
    private A() {}
    public static A getInstance() {
        if (_instance == null) {			// 1âƒ£ï¸
            synchronized (A.class) {
                if (_instance == null) {
                    _instance = new A();	// 2âƒ£ï¸
                }
            }
        }
        return _instance;
    }
}
</code></pre>

<p>æ³¨æ„è¿™é‡Œçš„2âƒ£ï¸å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œå¯ä»¥æ‹†åˆ†æˆä»¥ä¸‹æ“ä½œ</p>

<ol>
<li>ç”³è¯·å†…å­˜</li>
<li>è°ƒç”¨<code>A</code>çš„æ„é€ å‡½æ•°åˆå§‹åŒ–<code>_instance</code></li>
<li>å°†ç”³è¯·åˆ°çš„å†…å­˜åˆ†é…ç»™<code>_instance</code></li>
</ol>

<p>cpuä¼šè®¤ä¸º2å’Œ3çš„æ‰§è¡Œé¡ºåºä¸å½±å“æœ€ç»ˆäº§å‡ºç»“æœï¼Œæ‰€ä»¥å¯èƒ½ä¹±åºæ‰§è¡Œï¼Œçº¿ç¨‹t1å…ˆæ‰§è¡Œäº†3ï¼Œè¿˜æ²¡æ‰§è¡Œ2çš„æ—¶å€™ï¼Œçº¿ç¨‹t2è¿›äº†1âƒ£ï¸åˆ¤æ–­ï¼Œå‘ç°æœ‰å€¼ï¼Œç›´æ¥è¿”å›äº†<code>_instance</code>æ‹¿å‡ºå»ç”¨ï¼Œè¿™ä¸ªæ—¶å€™<code>_instance</code>å…¶å®è¿˜æ²¡åˆå§‹åŒ–å®Œæˆã€‚</p>

<p>è§£å†³åŠæ³•å°±æ˜¯ç»™<code>_instance</code>åŠ volatileå…³é”®å­—ï¼Œå› ä¸ºvolatileå…³é”®å­—é™¤äº†å¯è§æ€§ä¿è¯ä¹‹å¤–è¿˜æœ‰å¦ä¸€ä¸ªä¿è¯ï¼šå†™å…¥volatileå˜é‡ä¹‹å‰çš„æ“ä½œ&rdquo;happens before&rdquo;å†™å…¥æ“ä½œæœ¬èº«ï¼Œå³1/2è¿™ä¸¤æ¡è¯­å¥ä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸èƒ½å’Œ3ä¹±åºï¼Œ1/2ä¸¤ä¸ªä¹‹é—´æ˜¯å¦ä¹±åºç”±ä¹±åºè§„åˆ™è§„å®šï¼Œé€šè¿‡ç”Ÿæˆæ±‡ç¼–å†…å­˜å±éšœæŒ‡ä»¤å®ç°</p>

<h2 id="2-3-volatileä¸æ˜¯ä»€ä¹ˆ">2.3 volatileä¸æ˜¯ä»€ä¹ˆ</h2>

<p>volatileä¸æ˜¯åŸå­æ“ä½œï¼Œå³volatileä¸æä¾›CASé€»è¾‘çš„åŸå­æ€§ï¼Œè¦å®ç°CASçš„åŸå­æ€§å¿…é¡»ç”¨<code>Unsafe</code>ç±»é€šè¿‡cpuæŒ‡ä»¤å®ç°</p>

<h1 id="3-synchronizedå…³é”®å­—-monitor">3. synchronizedå…³é”®å­—(Monitor)</h1>

<p>synchronizedå…³é”®å­—å®ç°äº†monitorè¯­ä¹‰ï¼Œmonitoræ˜¯ï¼š</p>

<ul>
<li>monitorå†…åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®(å…¶ä½™è¿›å…¥entry set)</li>
<li>æä¾›ä¸»åŠ¨è®©å‡ºcpuæ—¶é—´ç‰‡ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿçš„æ–¹æ³•(waitï¼Œè¿›å…¥wait set)</li>
<li>æä¾›é€šçŸ¥å…¶ä»–çº¿ç¨‹æŸä¸ªäº‹ä»¶å‘ç”Ÿçš„æ–¹æ³•(notify)ï¼Œå”¤é†’wait setä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹</li>
</ul>

<p>jvmé€šè¿‡synchronizedå…³é”®å­—åŸç”Ÿæä¾›moniterenterå’ŒmonitorexitæŒ‡ä»¤ï¼Œè¿›å…¥/ç¦»å¼€monitorã€‚åœ¨synchronizedå—å†…éƒ¨é€šè¿‡wait/notify/notifyAllå®ç°monitorçš„åä¸¤æ¡è¯­ä¹‰ã€‚</p>

<p>wait/notify/notifyAllå¿…é¡»åœ¨synchronizedå—å†…æ‰§è¡Œ(å³å½“å‰çº¿ç¨‹æ˜¯monitorçš„æ‹¥æœ‰è€…)ï¼Œå¦åˆ™ä¼šæŠ›<code>java.lang.IllegalMonitorStateException</code>å¼‚å¸¸</p>

<p>è¢«<code>notifyAll</code>å”¤é†’çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…monitoré€€å‡ºä¹‹åæ‰èƒ½ç«äº‰monitorï¼ŒæŒ‰çº¿ç¨‹ä¼˜å…ˆçº§ã€ç­‰å¾…æ—¶é—´ç­‰æ¡ä»¶è®¡ç®—å“ªä¸ªçº¿ç¨‹èƒ½è·å¾—monitorï¼Œå¾—åˆ°monitorä¹‹åæ‰èƒ½ç»§ç»­æ‰§è¡Œ</p>

<h1 id="4-lock">4. Lock</h1>

<p><code>Lock</code>æ˜¯Javaæ ‡å‡†åº“æä¾›çš„æ¯”monitoræ›´åŠ çµæ´»çš„åŒæ­¥æœºåˆ¶ï¼Œæœ‰ç›¸åŒä¹Ÿæœ‰ä¸åŒã€‚</p>

<ul>
<li>lock()/moniterenter</li>
<li>unlock()/monitorexit</li>
<li>Condition.await()/Object.wait()</li>
<li>Condition.signal/Object.notify()</li>
</ul>

<p>ä¸åŒä¹‹å¤„åœ¨äºï¼Œä¸€ä¸ªLockå¯ä»¥å…³è”å¤šä¸ªConditionå¯¹è±¡</p>

<h2 id="4-1-å¸¸è§çš„lock">4.1 å¸¸è§çš„Lock</h2>

<h3 id="4-1-1-reentrantlock">4.1.1 ReentrantLock</h3>

<p>å¯é‡å…¥é”ï¼šå·²è·å¾—é”çš„çº¿ç¨‹å¯ä»¥å†æ¬¡è·å¾—é”è€Œä¸é˜»å¡ï¼Œå½“é”æ‹¥æœ‰è€…æ•°é‡ä¸º0æ—¶æ‰é‡Šæ”¾é”</p>

<h3 id="4-1-2-readwritelock-interface">4.1.2 ReadWriteLock(interface)</h3>

<p>è¯»å†™é”ï¼šå…è®¸å¤šä¸ªreaderåŒæ—¶è·å¾—ReadLockï¼Œæˆ–è€…ä¸€ä¸ªwriterè·å¾—WriteLockã€‚æ²¡æœ‰writerçº¿ç¨‹å¹¶ä¸”æ²¡æœ‰writer requestæ—¶ï¼Œå¯ä»¥å…è®¸æˆä¸ºreaderã€‚æ²¡æœ‰writerå’Œreaderæ—¶ï¼Œå…è®¸æˆä¸ºwriterã€‚</p>

<p>è¿™åªæ˜¯ä¸ªinterfaceï¼Œç”±<code>ReentrantReadWriteLock</code>å®ç°</p>

<h3 id="4-1-3-reentrantreadwritelock">4.1.3 ReentrantReadWriteLock</h3>

<p>å¯é‡å…¥è¯»å†™é”ï¼šå·²è·å¾—ReadLockçš„çº¿ç¨‹ï¼Œåœ¨æ²¡æœ‰å…¶ä»–readerå¹¶ä¸”æ²¡æœ‰writerçš„æƒ…å†µä¸‹ï¼Œå…è®¸è·å¾—writeré”ã€‚å·²è·å¾—WriteLockçš„çº¿ç¨‹ï¼Œå¦‚æœå·²ç»æ˜¯readeræˆ–è€…æ²¡æœ‰å…¶ä»–writer requestçš„æƒ…å†µä¸‹ï¼Œå…è®¸è·å¾—readeré”</p>

<h2 id="4-2-lockå®ç°">4.2 Lockå®ç°</h2>

<p><strong>ç¯‡å¹…æ‰€é™ï¼Œè¯¦ç»†å†…å®¹è¦æ–°å¼€ä¸€ç¯‡</strong></p>

<h3 id="4-2-1-é€šç”¨å®ç°">4.2.1 é€šç”¨å®ç°</h3>

<h4 id="aqs">AQS</h4>

<p>æ•´ä¸ªlockæ¡†æ¶åº•å±‚ç”±<code>AbstractQueuedSynchronizer</code>æä¾›å®ç°ï¼Œ<code>AbstractQueuedSynchronizer</code>ç”±<code>Unsafe</code>çš„CASæä¾›é”çš„å®ç°ï¼Œå½“çº¿ç¨‹æ²¡æœ‰æŠ¢åˆ°é”æ—¶ï¼Œä¼šè¿›å…¥åŸºäºé“¾è¡¨çš„ç­‰å¾…é˜Ÿåˆ—ã€‚</p>

<h4 id="è·å¾—é”">è·å¾—é”</h4>

<pre><code class="language-java">public final void acquire(int arg) {
	if (!tryAcquire(arg) &amp;&amp;
			acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
		selfInterrupt();
}
</code></pre>

<p><code>tryAcquire</code>ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±å„Lockå­ç±»æä¾›å®ç°ï¼Œä½œç”¨ä¸ºå°è¯•ä»¥ç‹¬å æ¨¡å¼è·å¾—é”</p>

<p><code>acquireQueued</code>å½“å°è¯•è·å–é”å¤±è´¥æ—¶ï¼Œå°†å½“å‰çº¿ç¨‹åŒ…è£…ååŠ å…¥ç­‰å¾…é˜Ÿåˆ—</p>

<h4 id="é‡Šæ”¾é”">é‡Šæ”¾é”</h4>

<pre><code class="language-java">public final boolean release(int arg) {
	if (tryRelease(arg)) {
		Node h = head;
		if (h != null &amp;&amp; h.waitStatus != 0)
			unparkSuccessor(h);
		return true;
	}
	return false;
}
</code></pre>

<p><code>tryRelease</code>ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œç”±å„Lockå­ç±»å®ç°ï¼Œä½œä¸ºå°è¯•åœ¨ç‹¬å æ¨¡å¼ä¸‹è§£é”çš„æ–¹æ³•</p>

<p>ç„¶åä»ç­‰å¾…é˜Ÿåˆ—ä¸­æ‹¿å‡ºå¤´éƒ¨èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œå”¤é†’ä¹‹</p>

<h3 id="4-2-2-reentrantlockå®ç°">4.2.2 ReentrantLockå®ç°</h3>

<p>ReentrantLockä¾èµ–å†…éƒ¨ä¸€ä¸ªæˆå‘˜å˜é‡syncï¼Œç»§æ‰¿äºAQSã€‚fairå’Œnon-fairæ¨¡å¼çš„é”å–å†³äºç”¨çš„æ˜¯å“ªä¸ªsyncå­ç±»ã€‚</p>

<p>ç±»ç»“æ„å›¾å¦‚å›¾æ‰€ç¤º</p>

<p><img src="https://i.imgur.com/OkLnU4q.png" alt="image-20180929154724854" /></p>

<h4 id="nonfairsync">NonfairSync</h4>

<p>éå…¬å¹³é”å®ç°ï¼Œ<code>tryAcquire</code>æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•</p>

<pre><code class="language-java">final boolean nonfairTryAcquire(int acquires) {
	final Thread current = Thread.currentThread();
	int c = getState();
	if (c == 0) {	// 1âƒ£ï¸
		if (compareAndSetState(0, acquires)) {	// 2âƒ£ï¸
			setExclusiveOwnerThread(current);
			return true;
		}
	}
	else if (current == getExclusiveOwnerThread()) { // 3âƒ£ï¸
		int nextc = c + acquires;
		if (nextc &lt; 0) // overflow
			throw new Error(&quot;Maximum lock count exceeded&quot;);
		setState(nextc);
		return true;
	}
	return false;
}
</code></pre>

<p>æ„æ€å°±æ˜¯ï¼Œå¦‚æœæ²¡äººå ç”¨è¿™ä¸ªé”(1âƒ£ï¸)ï¼Œé‚£ä¹ˆå°è¯•æŠ¢å (2âƒ£ï¸)ï¼Œå¦‚æœæˆåŠŸäº†ï¼Œå°±æˆåŠŸäº†ï¼Œå¤±è´¥äº†å°±è¿”å›åˆ°AQSçš„<code>acquire</code>æ–¹æ³•è¿›ç­‰å¾…é˜Ÿåˆ—å¹¶æŒ‚èµ·ã€‚å¦‚æœå·²ç»è¢«å ç”¨äº†ï¼Œå¹¶ä¸”è‡ªå·±å°±æ˜¯å ç”¨è€…(3âƒ£ï¸)ï¼Œé‚£ä¹ˆå¢åŠ è®¡æ•°state</p>

<h4 id="fairsync">FairSync</h4>

<p>å…¬å¹³é”å®ç°</p>

<pre><code class="language-java">protected final boolean tryAcquire(int acquires) {
	final Thread current = Thread.currentThread();
	int c = getState();
	if (c == 0) {
		if (!hasQueuedPredecessors() &amp;&amp;		// 1âƒ£ï¸
				compareAndSetState(0, acquires)) {
			setExclusiveOwnerThread(current);
			return true;
		}
	}
	else if (current == getExclusiveOwnerThread()) {
		int nextc = c + acquires;
		if (nextc &lt; 0)
			throw new Error(&quot;Maximum lock count exceeded&quot;);
		setState(nextc);
		return true;
	}
	return false;
}
</code></pre>

<p>è¿™æ¯”éå…¬å¹³é”åªå¤šäº†1âƒ£ï¸è¿™è¡Œï¼Œå…¬å¹³é”åœ¨å°è¯•æŠ¢å ä¹‹å‰ï¼Œä¼šçœ‹ä¸€çœ¼ç­‰å¾…é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰çº¿ç¨‹å·²ç»åœ¨ç­‰å¾…ï¼Œå¦‚æœæœ‰ï¼Œä¹–ä¹–è¿”å›AQSçš„<code>acquire</code>æ–¹æ³•è¿›ç­‰å¾…é˜Ÿåˆ—ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œä¸ä¼šå¯¼è‡´ç­‰å¾…é˜Ÿåˆ—é‡Œçš„çº¿ç¨‹é¥¿æ­»ã€‚åå¤„æ˜¯ï¼Œç•¥å¾®é™ä½äº†ååé‡(TODO: éœ€è¦æµ‹è¯•æ•°æ®æ”¯æ’‘)</p>

<h3 id="4-2-3-reentrantreadwritelockå®ç°">4.2.3 ReentrantReadWriteLockå®ç°</h3>

<p>å…¶ä¸­åŒ…å«<code>ReadLock</code>å’Œ<code>WriteLock</code>ï¼Œè¿™ä¸¤ä¸ªæœ€ç»ˆåˆä¾èµ–ç»§æ‰¿äº<code>AbstractQueuedSynchronizer</code>çš„å®ç°Sync</p>

<p>å’Œ<code>ReentrantLock</code>ä¸€æ ·ï¼Œä¹Ÿæœ‰FairSyncå’ŒNonfairSyncã€‚ä¸åŒäº<code>ReentrantLock</code>,<code>ReentrantReadWriteLock</code>åˆ†åˆ«åˆ©ç”¨äº†stateå­—æ®µçš„é«˜ä½4ä½æ¥è¡¨ç¤ºè¯»é”å’Œå†™é”å ç”¨æ•°é‡</p>

<p><code>WriteLock</code>ä¼šè°ƒç”¨</p>

<pre><code class="language-java">protected final boolean tryAcquire(int acquires) {
	Thread current = Thread.currentThread();
	int c = getState();
	int w = exclusiveCount(c);
	if (c != 0) {
		// (Note: if c != 0 and w == 0 then shared count != 0)
		if (w == 0 || current != getExclusiveOwnerThread())		// 1âƒ£ï¸
			return false;
		if (w + exclusiveCount(acquires) &gt; MAX_COUNT)
			throw new Error(&quot;Maximum lock count exceeded&quot;);
		// Reentrant acquire
		setState(c + acquires);
		return true;
	}
	if (writerShouldBlock() ||		// 2âƒ£ï¸
			!compareAndSetState(c, c + acquires))	// 3âƒ£ï¸
		return false;
	setExclusiveOwnerThread(current);	// 4âƒ£ï¸
	return true;
}
</code></pre>

<p>ä»£ç 1âƒ£ï¸å¤„åˆ†ä¸¤ç§æƒ…å†µï¼Œéƒ½ä¸èƒ½è·å¾—å†™é”</p>

<ul>
<li>wæ˜¯å†™é”å ç”¨æ•°ï¼Œstate != 0 &amp;&amp; w == 0 =&gt; è¯»é”å ç”¨æ•°&gt;0ï¼Œä¸èƒ½è·å¾—å†™é”</li>
<li>w != 0 &amp;&amp; current != getExclusiveOwnerThread()ï¼Œæœ‰äººå äº†å†™é”ï¼Œä½†ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œä¸èƒ½è·å¾—å†™é”</li>
</ul>

<p>å½“æ²¡äººå ç”¨ä»»ä½•é”ï¼Œå¹¶ä¸”writerä¸ç”¨é˜»å¡çš„æ—¶å€™(2âƒ£ï¸)ï¼Œå°è¯•æŠ¢å (3âƒ£ï¸)ï¼Œè®¾ç½®ç‹¬å çº¿ç¨‹(4âƒ£ï¸)ã€‚<code>writerShouldBlock()</code>æ˜¯æŠ½è±¡æ–¹æ³•ç”±å­ç±»å®ç°(æ˜¯å¦å…¬å¹³é”)</p>

<p><code>ReadLock</code>å®ç°</p>

<pre><code class="language-java">// todo ç¯‡å¹…è¾ƒé•¿ï¼Œè€ƒè™‘ç‹¬ç«‹
</code></pre>

<h4 id="nonfairsync-fairsync">NonfairSync &amp; FairSync</h4>

<p>ç”±äºä¸»è¦å·¥ä½œéƒ½åœ¨çˆ¶ç±»<code>Sync</code>é‡Œå®Œæˆäº†ï¼Œè¿™ä¸¤ä¸ªå­ç±»ä»…å®ç°readeræˆ–è€…writeræ˜¯å¦éœ€è¦ä¸»åŠ¨é˜»å¡çš„é€»è¾‘</p>

<p><strong>NonfairSync</strong></p>

<p>writeræ°¸è¿œä¸éœ€è¦ä¸»åŠ¨é˜»å¡ã€‚</p>

<p>readerä¼šçœ‹ç­‰å¾…é˜Ÿåˆ—é‡Œçš„ç¬¬ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦æ˜¯å†™çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å†™çº¿ç¨‹ï¼Œåˆ™ä¸»åŠ¨é˜»å¡ã€‚è¿™é‡Œå¹¶ä¸æ˜¯è®©å†™çº¿ç¨‹æœ‰è¶³å¤Ÿé«˜çš„ä¼˜å…ˆçº§ä¼˜å…ˆæ‰§è¡Œï¼Œè€Œæ˜¯ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘å†™çº¿ç¨‹é¥¿æ­»çš„è‚¯æ©è¡Œã€‚æ‰€ä»¥è¿™ä¸ªä¸å…¬å¹³é”å¯¹ç­‰å¾…ä¸­çš„å†™çº¿ç¨‹è¿˜æ˜¯æœ‰ä¸€ç‚¹ç‚¹å…¬å¹³çš„</p>

<p><strong>FairSync</strong></p>

<p>è¯»å†™çº¿ç¨‹éƒ½ä¼šå…ˆçœ‹çœ‹ç­‰å¾…é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œæœ‰å°±å»æ’é˜Ÿï¼Œä¸»åŠ¨é˜»å¡</p>

<h2 id="4-3-conditionå®ç°">4.3 Conditionå®ç°</h2>

<p><code>Condition</code>æ˜¯<code>ReentrantLock</code>æ´¾ç”Ÿå‡ºæ¥çš„ï¼Œå¯ä»¥åœ¨è·å¾—é”ä¹‹ååœ¨çº¿ç¨‹é—´åŒæ­¥çš„æœºåˆ¶ã€‚è·Ÿ<code>ReentrantLock</code>å…³è”ï¼Œå¿…é¡»åœ¨è·å¾—é”ä¹‹åä½¿ç”¨ã€‚</p>

<p><code>Condition</code>æœ‰<code>await</code>å’Œ<code>signal</code>æ–¹æ³•ï¼Œä½œç”¨å’ŒObjectçš„<code>wait</code>/<code>notify</code>ä¸€æ ·ã€‚å†…éƒ¨å®ç°ä¸Šï¼Œå…³è”äº†ç”Ÿæˆå®ƒçš„<code>ReentrantLock</code>å¯¹è±¡ï¼Œè‡ªèº«ä¹Ÿæœ‰ç±»ä¼¼<code>ReentrantLock</code>ç­‰å¾…é˜Ÿåˆ—çš„æ¡ä»¶é˜Ÿåˆ—ã€‚å½“awaitçš„æ—¶å€™å…ˆæŠŠå½“å‰çº¿ç¨‹åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…signalå°†çº¿ç¨‹è½¬ç§»åˆ°<code>ReentrantLock</code>çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šï¼Œç­‰å¾…<code>ReentrantLock</code>è°ƒåº¦</p>

<h3 id="4-3-1-await">4.3.1 await</h3>

<p>ä¸»é€»è¾‘å¦‚ä¸‹</p>

<pre><code class="language-java">public final void await() throws InterruptedException {
	if (Thread.interrupted())
		throw new InterruptedException();
	Node node = addConditionWaiter();		// 1âƒ£ï¸
	int savedState = fullyRelease(node);	// 2âƒ£ï¸
	int interruptMode = 0;
	while (!isOnSyncQueue(node)) {			// 3âƒ£ï¸
		LockSupport.park(this);
		if ((interruptMode = checkInterruptWhileWaiting(node)) != 0)
			break;
	}
	if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)	// 4âƒ£ï¸
		interruptMode = REINTERRUPT;
	if (node.nextWaiter != null) // clean up if cancelled
		unlinkCancelledWaiters();
	if (interruptMode != 0)
		reportInterruptAfterWait(interruptMode);
}
</code></pre>

<p>å‡ ä¸ªå…³é”®é€»è¾‘</p>

<p>1âƒ£ï¸å°†å½“å‰çº¿ç¨‹åŠ å…¥<code>Condition</code>çš„ç­‰å¾…é˜Ÿåˆ—(é“¾è¡¨ç»“æ„)ä¸­</p>

<p>2âƒ£ï¸é‡Šæ”¾å½“å‰çº¿ç¨‹æŒæœ‰çš„<code>ReentrantLock</code>ï¼Œæ³¨æ„è¿™é‡Œéœ€è¦fullyReleaseï¼Œå› ä¸ºé”å¯é‡å…¥</p>

<p>3âƒ£ï¸å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹è¢«signalè½¬ç§»åˆ°<code>ReentrantLock</code>çš„ç­‰å¾…é˜Ÿåˆ—é‡Œ</p>

<p>4âƒ£ï¸acquireQueuedè¿”å›ä¹‹åï¼Œå½“å‰çº¿ç¨‹å°±æŒæœ‰äº†<code>ReentrantLock</code></p>

<h3 id="4-3-2-signal">4.3.2 signal</h3>

<p>å…³é”®é€»è¾‘</p>

<pre><code class="language-java">private void doSignal(Node first) {
	do {
		if ( (firstWaiter = first.nextWaiter) == null)
			lastWaiter = null;
		first.nextWaiter = null;
	} while (!transferForSignal(first) &amp;&amp;
			(first = firstWaiter) != null);
}

final boolean transferForSignal(Node node) {
	if (!compareAndSetWaitStatus(node, Node.CONDITION, 0))
		return false;

	Node p = enq(node);
	int ws = p.waitStatus;
	if (ws &gt; 0 || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))
		LockSupport.unpark(node.thread);
	return true;
}
</code></pre>

<p>doSignaléå†<code>Condition</code>çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªèƒ½è¢«æˆåŠŸè½¬ç§»åˆ°<code>ReentrantLock</code>ç­‰å¾…é˜Ÿåˆ—çš„çº¿ç¨‹ï¼Œå®Œæˆsignalæ“ä½œ</p>

<p>transferForSignalç¬¬ä¸€ä¸ªCASæ³¨é‡Šä¸Šè¯´å¦‚æœwaitStatusä¸æ˜¯CONDITIONï¼Œé‚£ä¹ˆè¡¨ç¤ºnodeè¢«cancelï¼Œè¿™å—ä¸æ˜¯å¾ˆç†è§£ä»€ä¹ˆæ—¶å€™ä¼šè¢«cancelï¼Œæ€»ä¹‹å°±æ˜¯å½“å‰nodeæ— æ•ˆï¼Œè½¬ç§»å¤±è´¥ã€‚å½“waitStatusæˆåŠŸå˜æˆ0(ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„nodeç±»å‹)ä¹‹åï¼Œå°†nodeé€šè¿‡enqæ”¾åˆ°ç­‰å¾…é˜Ÿåˆ—é‡Œï¼Œpæ˜¯nodeçš„å‰åºèŠ‚ç‚¹ã€‚</p>

<p>è¿™é‡Œä¸æ˜¯å¾ˆç†è§£æœ€åè¿™ä¸ªifçš„é€»è¾‘ï¼Œçœ‹èµ·æ¥æ˜¯å¦‚æœå‰åºèŠ‚ç‚¹çš„waitStatusä¸æ˜¯SIGNAL(è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ²¡åœ¨SIGNALçŠ¶æ€)ï¼Œé‚£ä¹ˆå”¤é†’å½“å‰çº¿ç¨‹???</p>

<h1 id="5-lock-free">5. Lock Free</h1>

<p>ä¸ªäººç†è§£ï¼Œlockçš„æœ€å¤§é—®é¢˜åœ¨ä»¥ä¸‹å‡ ç‚¹</p>

<ul>
<li>ç«äº‰å¤±è´¥éœ€è¦å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå…¥é˜Ÿå‡ºé˜Ÿéœ€è¦è·Ÿç­‰å¾…é˜Ÿåˆ—æœ‰äº¤äº’</li>
<li>çº¿ç¨‹æŒ‚èµ·/åˆ‡æ¢ä»£ä»·å¤§ï¼Œå¼•å‘contextä¿å­˜/æ¢å¤ã€cpu cache missç­‰é—®é¢˜</li>
</ul>

<p>lock freeç›¸å¯¹äºlock basedç®—æ³•ä¼šæœ‰ä»¥ä¸Šä¼˜åŠ¿ï¼Œä½†ä¸æ˜¯é“¶å¼¹ã€‚lock freeçš„ä¸»è¦ç®—æ³•æ˜¯spin + cas</p>

<pre><code class="language-java">public class LockFree {
    private int i = 0;	// â‘ 

    private static final Unsafe UNSAFE = Unsafe.getUnsafe();
    private static long iOffset = 0;	// â‘¡
    static {
        try {
            iOffset = UNSAFE.objectFieldOffset(LockFree.class.getDeclaredField(&quot;i&quot;));
        } catch (NoSuchFieldException e) {
            throw new Error(e);
        }
    }

    public void incr() {
        while (true) {
            int old = i;
            i++;
            if (UNSAFE.compareAndSwapInt(this, iOffset, old, i)) {		// â‘¢
                break;
            }
        }
    }
}
</code></pre>

<ol>
<li><p>æ•°æ®å­—æ®µ</p></li>

<li><p>unsafeå¾—åˆ°çš„è¿™ä¸ªå­—æ®µåœ¨å†…å­˜ä¸­çš„åç§»é‡ï¼Œçº¦ç­‰äºCé‡Œçš„(&amp;struct.field - &amp;struct)</p></li>

<li><p>CASæ“ä½œï¼Œåœ¨nativeæ–¹æ³•ä¸­æœ€ç»ˆä¼šè°ƒç”¨åˆ°CPUçš„CASæŒ‡ä»¤ï¼ŒåŸå­èµ‹å€¼</p></li>
</ol>

<p>ä¹è§‚é”å®ç°ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½çœ‹åˆ°oldå’Œiçš„å€¼ç›¸ç­‰è€Œæ”¹å˜å€¼ï¼Œå…¶ä»–çº¿ç¨‹è¿”å›whileå¼€å¤´é‡æ–°ç«äº‰ã€‚ä¸ªäººè®¤ä¸ºLock Freeä¼šæœ‰ä»¥ä¸‹é—®é¢˜</p>

<ul>
<li>åœ¨ç«äº‰éå¸¸æ¿€çƒˆçš„åœºåˆï¼Œå³é•¿æœŸæœ‰å¤§é‡ç«äº‰ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æœ‰å¾ˆå¤šçº¿ç¨‹åœ¨ç©ºè€—CPUè‡ªæ—‹</li>
<li>åªé€‚åˆä¸´ç•ŒåŒºéå¸¸è½»é‡çš„åœºåˆï¼Œå³ä¸´ç•ŒåŒºå†…æ‰§è¡Œæ—¶é—´å¾ˆçŸ­</li>
<li>éå…¬å¹³å®ç°ï¼Œå¯èƒ½ä¼šæœ‰çº¿ç¨‹é¥¿æ­»</li>
</ul>

<h1 id="6-å¸¸ç”¨åŒæ­¥å·¥å…·">6. å¸¸ç”¨åŒæ­¥å·¥å…·</h1>

<p>concurrentåŒ…ä¸‹çš„åŒæ­¥å·¥å…·åŸºæœ¬éƒ½æ˜¯<code>AbstractQueuedSynchronizer</code>çš„ç›´æ¥ä½¿ç”¨(å†…éƒ¨ä½¿ç”¨å…¶å­ç±»)ï¼Œæˆ–è€…é—´æ¥ä½¿ç”¨(ç”¨<code>ReentrantLock</code>)</p>

<h2 id="countdownlatch">CountDownLatch</h2>

<p>è®¾ç½®ç­‰å¾…æ•°é‡ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹ç­‰åœ¨latchä¸Šï¼ŒNä¸ªçº¿ç¨‹countDown()ï¼Œåœ¨æ‰€æœ‰çº¿ç¨‹countDown()å®Œä¹‹åï¼Œç­‰å¾…çº¿ç¨‹æ”¾è¡Œã€‚å…¸å‹åœºæ™¯å°±æ˜¯å¤šçº¿ç¨‹ç»Ÿè®¡çš„æ—¶å€™ï¼ŒNä¸ªçº¿ç¨‹ç»Ÿè®¡å®Œäº†ä¹‹ååœ¨ç­‰å¾…çº¿ç¨‹ä¸Šå½’å¹¶</p>

<p>å®ç°ä¸Šï¼Œå†…éƒ¨ç»§æ‰¿AQSï¼Œä»¥share modeä½¿ç”¨ï¼Œstateå½’é›¶ä¹‹åå¯ä»¥è·å¾—é”</p>

<pre><code class="language-java">protected int tryAcquireShared(int acquires) {
    return (getState() == 0) ? 1 : -1;
}

protected boolean tryReleaseShared(int releases) {
    // Decrement count; signal when transition to zero
    for (;;) {
        int c = getState();
        if (c == 0)
            return false;
        int nextc = c-1;
        if (compareAndSetState(c, nextc))
            return nextc == 0;
    }
}
</code></pre>

<h2 id="semaphore">Semaphore</h2>

<p>å®¹é‡ä¸ºNçš„èµ„æºï¼Œæ¯acquire()ä¸€æ¬¡-1ï¼Œåˆ°0çš„æ—¶å€™é˜»å¡ï¼Œç­‰å‰é¢æŒæœ‰èµ„æºçš„äººrelease()</p>

<p>å®ç°ä¸Šï¼Œå¾ˆç›´æ¥çš„AQSåº”ç”¨ï¼Œshare modeï¼Œè®¾ç½®åˆå§‹stateå€¼ï¼Œå¤§äº0çš„æ—¶å€™å…è®¸è·å¾—é”ï¼Œåˆ°0é˜»å¡</p>

<p>ä¹Ÿåˆ†fairå’Œnon-fairï¼ŒåŒºåˆ«å’Œ<code>ReentrantLock</code>ä¸€æ ·ï¼Œåœ¨äºæŠ¢é”å‰æ˜¯å¦ä¼šçœ‹ä¸€çœ¼é˜Ÿåˆ—é‡Œæœ‰æ²¡æœ‰ç­‰å¾…çº¿ç¨‹</p>

<h2 id="cyclicbarrier">CyclicBarrier</h2>

<p>è®¾ç½®ä¸ªåˆå§‹é‡Nï¼Œåœ¨è¿™Nä¸ªçº¿ç¨‹éƒ½await()ä¹‹åæ‰€æœ‰çº¿ç¨‹æ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™é˜»å¡ã€‚çº¿ç¨‹ä¸­æ–­å¯ä»¥æ‰“ç ´è¿™ä¸ªbarrierï¼Œæ‰€æœ‰awaitä¸­çš„çº¿ç¨‹æŠ›<code>InterruptedException</code></p>

<p>å®ç°ä¸Šï¼Œç”¨<code>ReentrantLock</code>åšåŒæ­¥ï¼Œå†…éƒ¨ç”¨ä¸€ä¸ªgenerationçš„æ¦‚å¿µåŒºåˆ†æ¯ä¸€æ¬¡å…¨å‘˜åˆ°è¾¾barrierä¹‹å‰çš„çŠ¶æ€ï¼Œæ¯æ¬¡åˆ°è¾¾barrierä¹‹åé‡ç½®è¿™ä¸ªgeneration</p>

<h1 id="7-çº¿ç¨‹æ± ">7. çº¿ç¨‹æ± </h1>

<p>çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™æœ‰é¢å¤–çš„å¼€é”€ï¼ŒOSéœ€è¦åˆ›å»ºçº¿ç¨‹å†…æ ¸æ•°æ®ç»“æ„ã€åˆ†é…æ ˆå†…å­˜(fork/COW)ã€ç®¡ç†è°ƒåº¦é˜Ÿåˆ—ï¼ŒJVMéœ€è¦åˆ›å»º<code>Thread</code>å¯¹è±¡ã€åˆ†é…æ ˆç©ºé—´ã€å…³è”OSçº¿ç¨‹ç­‰æ“ä½œï¼Œæ‰€ä»¥ä¸€èˆ¬å¤šçº¿ç¨‹ç¨‹åºä¸ä¼šé¢‘ç¹åˆ›å»º/ç»“æŸçº¿ç¨‹ï¼Œè€Œæ˜¯å°†çº¿ç¨‹æ± åŒ–ï¼Œè¦ç”¨çš„æ—¶å€™å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œç”±çº¿ç¨‹æ± å»æ‰¾çº¿ç¨‹æ‰§è¡Œ(å¦‚æœæ‰¾å¾—åˆ°çš„è¯)ï¼Œç»“æŸåå½’è¿˜çº¿ç¨‹æ± ç­‰å¾…æ–°ä»»åŠ¡ã€‚</p>

<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>

<p>Javaçº¿ç¨‹æ± ä¸»è¦ç”±<code>ThreadPoolExecutor</code>(åŠå…¶å­ç±»)å®ç°ï¼Œé€šè¿‡<code>void execute(Runnable command)</code>(æˆ–<code>Future&lt;?&gt; submit(Runnable task)</code>ï¼Œå¦‚æœéœ€è¦åç»­æ‹¿è¿”å›ç»“æœ)å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡æ‰§è¡Œï¼Œsubmitæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨executeã€‚</p>

<p>å®Œæ•´ç‰ˆæ„é€ å‡½æ•°</p>

<pre><code class="language-java">public ThreadPoolExecutor(int corePoolSize,
                          int maximumPoolSize,
                          long keepAliveTime,
                          TimeUnit unit,
                          BlockingQueue&lt;Runnable&gt; workQueue,
                          ThreadFactory threadFactory,
                          RejectedExecutionHandler handler)
</code></pre>

<ul>
<li>corePoolSizeï¼Œæ± å†…idleçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œä¸€èˆ¬ä¸ä¼šè¢«å›æ”¶ï¼Œé™¤éè®¾ç½®äº†allowCoreThreadTimeOut</li>
<li>maximumPoolSizeï¼Œæ€»çº¿ç¨‹æ•°é‡ï¼Œçº¿ç¨‹æ•°é‡åœ¨(corePoolSize, maximumPoolSize]åŒºé—´æ—¶ï¼Œidleçº¿ç¨‹è¶…æ—¶ä¼šè¢«å›æ”¶</li>
<li>keepAliveTimeï¼Œidleçº¿ç¨‹è¶…æ—¶æ—¶é—´</li>
<li>unitï¼ŒkeepAliveTimeå•ä½</li>
<li>workQueueï¼Œç­‰å¾…é˜Ÿåˆ—</li>
<li>ThreadFactoryï¼Œåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»</li>
<li>RejectedExecutionHandlerï¼Œçº¿ç¨‹æ± æ‹’ç»ä»»åŠ¡åçš„å›è°ƒ</li>
</ul>

<h2 id="å®ç°">å®ç°</h2>

<p>å®ç°ä¸Šï¼Œå†…éƒ¨ç”±<code>AtomicInteger ctl</code>æ§åˆ¶çº¿ç¨‹æ± å†…éƒ¨çŠ¶æ€ï¼Œå…¶ä¸­é«˜3ä½å­˜å‚¨æ‰§è¡ŒçŠ¶æ€(RUNNING/SHUTDOWN/STOP/TIDYING/TERMINATED)ï¼Œä½3ä½å­˜å‚¨å·¥ä½œçº¿ç¨‹æ•°ã€‚</p>

<p><code>execute(Runnable command)</code>å®ç°å¦‚ä¸‹</p>

<pre><code class="language-java">public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    int c = ctl.get();
    if (workerCountOf(c) &lt; corePoolSize) {	// â‘ 
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    if (isRunning(c) &amp;&amp; workQueue.offer(command)) {	// â‘¡
        int recheck = ctl.get();
        if (! isRunning(recheck) &amp;&amp; remove(command))
            reject(command);
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    else if (!addWorker(command, false))	// â‘¢
        reject(command);
}
</code></pre>

<p>ä¸»è¦é€»è¾‘æ˜¯</p>

<ol>
<li>å¦‚æœå·¥ä½œçº¿ç¨‹æ•°æ¯”coreæ•°é‡å°‘ï¼Œç›´æ¥é€šè¿‡<code>addWorker</code>å¢åŠ å·¥ä½œçº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå½“å‰è¿™ä¸ªä»»åŠ¡</li>
<li>è¶…è¿‡coreæ•°é‡ä¹‹åï¼Œåç»­ä»»åŠ¡å…ˆå¡ç­‰å¾…é˜Ÿåˆ—</li>
<li>å¦‚æœç­‰å¾…é˜Ÿåˆ—æ»¡äº†(2çš„offerå¤±è´¥)ï¼Œå†æ–°å¼€çº¿ç¨‹æ‰§è¡Œ</li>
</ol>

<p>ä»¥ä¸Šå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡çš„ï¼Œå¾ˆå¯èƒ½åæ¥æ²¡æœºä¼šè¿›é˜Ÿåˆ—çš„ä»»åŠ¡æ¯”æ—©å…ˆå…ˆè¿›ç­‰å¾…é˜Ÿåˆ—çš„å…ˆæ‰§è¡Œï¼Œè¿™å—å¯èƒ½æŸäº›ä¸šåŠ¡åœºæ™¯<strong><em>ä¼šæœ‰é—®é¢˜</em></strong></p>

<p><code>addWorker(Runnable firstTask, boolean core)</code>ä¸»å¹²é€»è¾‘å¦‚ä¸‹(æœ‰åˆ èŠ‚ï¼Œä¸»è¦æ˜¯ç»´æŠ¤è®¡æ•°ç›¸å…³çš„ä»£ç )</p>

<pre><code class="language-java">private boolean addWorker(Runnable firstTask, boolean core) {
    // å†…éƒ¨è®¡æ•°......
    
    boolean workerStarted = false;
    boolean workerAdded = false;
    Worker w = null;
    try {
        w = new Worker(firstTask);		// â‘ 
        final Thread t = w.thread;
        if (t != null) {
            // workeré›†åˆæ“ä½œ......
            
            if (workerAdded) {
                t.start();			// â‘¡
                workerStarted = true;
            }
        }
    } finally {
        if (! workerStarted)
            addWorkerFailed(w);
    }
    return workerStarted;
}

private final class Worker
    extends AbstractQueuedSynchronizer
    implements Runnable {
    final Thread thread;
    }
</code></pre>

<ol>
<li>addWorkerä¸»è¦newäº†ä¸€ä¸ªWorkerå¯¹è±¡ï¼Œçœ‹Workerå¯¹è±¡çš„å®šä¹‰å¯ä»¥å‘ç°å®ƒå®ç°äº†Runnableæ¥å£ï¼Œå¹¶ä¸”å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªThreadï¼Œå¹¶ä¸”æœ¬èº«å°±æ˜¯ä¸ªAQSã€‚å°±æ˜¯è¯´å¯ä»¥æŠŠä»–åŒæ—¶å½“ä¸€ä¸ªçº¿ç¨‹å’Œä¸€ä¸ªé”æ¥ç”¨</li>
<li>åˆå§‹åŒ–å·¥ä½œå®Œæˆä¹‹åå¯åŠ¨Workerå†…éƒ¨ç»´æŠ¤çš„çº¿ç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>java.util.concurrent.ThreadPoolExecutor#runWorker</code>ï¼Œ<code>runWorker</code>ä¸»è¦é€»è¾‘æ˜¯æ­»å¾ªç¯è°ƒç”¨<code>getTask</code>ä»ç­‰å¾…é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œ</li>
</ol>

<p><code>Runnable getTask()</code>é€»è¾‘</p>

<pre><code class="language-java">private Runnable getTask() {
    boolean timedOut = false; // Did the last poll() time out?

    for (;;) {
        // ...

        int wc = workerCountOf(c);

        // Are workers subject to culling?
        boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;	// â‘ 

        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {	// â‘¢
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }

        try {
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();		// â‘¡
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
</code></pre>

<p>æ³¨æ„ç¼–å·é¡ºåº</p>

<ol>
<li>åœ¨æ ‡è®°äº†allowCoreThreadTimeOutæˆ–è€…å·¥ä½œçº¿ç¨‹æ•°å¤§äºcoreæ•°é‡æ—¶éœ€è¦è®¾ç½®è¶…æ—¶</li>
<li>ä»é˜Ÿåˆ—é‡Œæ‹¿taskï¼Œçœ‹1æœ‰æ²¡æœ‰è®¾ç½®è¶…æ—¶æ¥å†³å®šç­‰å¾…æ˜¯å¦éœ€è¦è¶…æ—¶</li>
<li>è¶…æ—¶å¹¶ä¸”é˜Ÿåˆ—é‡Œæ²¡taskçš„æ—¶å€™ï¼ŒCASæˆåŠŸä¹‹åè¿”å›nullï¼Œå‘Šè¯‰å·¥ä½œçº¿ç¨‹å¯ä»¥ç»“æŸå¾ªç¯è€Œé€€å‡ºï¼Œå›æ”¶å·¥ä½œçº¿ç¨‹</li>
</ol>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">hbprotoss</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-09-27</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh"><img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 3.0 æœªæœ¬åœ°åŒ–ç‰ˆæœ¬è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯ã€‚</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/java/">Java</a>
          
          <a href="/tags/concurrent/">Concurrent</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/netty%E5%9C%A8dubbo%E4%BC%A0%E8%BE%93%E5%B1%82%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Nettyåœ¨dubboä¼ è¾“å±‚ä¸­çš„åº”ç”¨</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/io%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/">
            <span class="next-text nav-default">IOå¤šè·¯å¤ç”¨</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'hbprotoss';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://weibo.com/hbprotoss" class="iconfont icon-weibo" title="weibo"></a>
  <a href="http://hbprotoss.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2017 - 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">hbprotoss</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>








</body>
</html>
