<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>ä¸€ä¸ªmysqlæ­»é”åœºæ™¯åˆ†æ - hbprotossçš„åšå®¢</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="hbprotoss" />
  <meta name="description" content="æœ€è¿‘é‡åˆ°ä¸€ä¸ªmysqlåœ¨RRçº§åˆ«ä¸‹çš„æ­»é”é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ„æ€ï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ã€‚ æ¶‰åŠçŸ¥è¯†ç‚¹ï¼šå…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ã€é—´éš™é”ã€æ’å…¥æ„å‘é”ã€é”" />

  <meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.54.0" />


<link rel="canonical" href="http://hbprotoss.github.io/post/%E4%B8%80%E4%B8%AAmysql%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="ä¸€ä¸ªmysqlæ­»é”åœºæ™¯åˆ†æ" />
<meta property="og:description" content="æœ€è¿‘é‡åˆ°ä¸€ä¸ªmysqlåœ¨RRçº§åˆ«ä¸‹çš„æ­»é”é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ„æ€ï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ã€‚ æ¶‰åŠçŸ¥è¯†ç‚¹ï¼šå…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ã€é—´éš™é”ã€æ’å…¥æ„å‘é”ã€é”" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://hbprotoss.github.io/post/%E4%B8%80%E4%B8%AAmysql%E6%AD%BB%E9%94%81%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90/" />
<meta property="article:published_time" content="2019-03-03T14:11:27&#43;08:00"/>
<meta property="article:modified_time" content="2019-03-03T14:11:27&#43;08:00"/>

<meta itemprop="name" content="ä¸€ä¸ªmysqlæ­»é”åœºæ™¯åˆ†æ">
<meta itemprop="description" content="æœ€è¿‘é‡åˆ°ä¸€ä¸ªmysqlåœ¨RRçº§åˆ«ä¸‹çš„æ­»é”é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ„æ€ï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ã€‚ æ¶‰åŠçŸ¥è¯†ç‚¹ï¼šå…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ã€é—´éš™é”ã€æ’å…¥æ„å‘é”ã€é”">


<meta itemprop="datePublished" content="2019-03-03T14:11:27&#43;08:00" />
<meta itemprop="dateModified" content="2019-03-03T14:11:27&#43;08:00" />
<meta itemprop="wordCount" content="3266">



<meta itemprop="keywords" content="Database,MySQL," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ä¸€ä¸ªmysqlæ­»é”åœºæ™¯åˆ†æ"/>
<meta name="twitter:description" content="æœ€è¿‘é‡åˆ°ä¸€ä¸ªmysqlåœ¨RRçº§åˆ«ä¸‹çš„æ­»é”é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ„æ€ï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ã€‚ æ¶‰åŠçŸ¥è¯†ç‚¹ï¼šå…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ã€é—´éš™é”ã€æ’å…¥æ„å‘é”ã€é”"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">hbprotossçš„åšå®¢</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">hbprotossçš„åšå®¢</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">ä¸€ä¸ªmysqlæ­»é”åœºæ™¯åˆ†æ</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-03-03 </span>
        
        <span class="more-meta"> 3266 words </span>
        <span class="more-meta"> 7 mins read </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#åœºæ™¯">åœºæ™¯</a>
<ul>
<li><a href="#å…±äº«-s-é”-äº’æ–¥-x-é”">å…±äº«(S)é”/äº’æ–¥(X)é”</a></li>
<li><a href="#æ„å‘é”">æ„å‘é”</a></li>
<li><a href="#è¡Œé”">è¡Œé”</a></li>
<li><a href="#é—´éš™é”">é—´éš™é”</a></li>
<li><a href="#æ’å…¥æ„å‘é”">æ’å…¥æ„å‘é”</a></li>
</ul></li>
<li><a href="#æ­»é”è¿‡ç¨‹åˆ†æ">æ­»é”è¿‡ç¨‹åˆ†æ</a></li>
<li><a href="#one-more-thing">One More Thing</a></li>
<li><a href="#æ€»ç»“">æ€»ç»“</a></li>
<li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      

<p>æœ€è¿‘é‡åˆ°ä¸€ä¸ªmysqlåœ¨RRçº§åˆ«ä¸‹çš„æ­»é”é—®é¢˜ï¼Œæ„Ÿè§‰æœ‰ç‚¹æ„æ€ï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œåšä¸ªè®°å½•ã€‚
æ¶‰åŠçŸ¥è¯†ç‚¹ï¼šå…±äº«é”ã€æ’ä»–é”ã€æ„å‘é”ã€é—´éš™é”ã€æ’å…¥æ„å‘é”ã€é”ç­‰å¾…é˜Ÿåˆ—</p>

<h2 id="åœºæ™¯">åœºæ™¯</h2>

<p>éš”ç¦»çº§åˆ«ï¼šRepeatable-Read</p>

<p>è¡¨ç»“æ„å¦‚ä¸‹</p>

<pre><code class="language-sql">create table t (
    id int not null primary key AUTO_INCREMENT,
    a int not null default 0,
    b varchar(10) not null default '',
    c varchar(10) not null default '',
    unique key uniq_a_b(a,b),
    unique key uniq_c(c)
);
</code></pre>

<p>åˆå§‹åŒ–æ•°æ®</p>

<pre><code class="language-sql">insert into t(a,b,c) values(1,'1','1');
</code></pre>

<p>æœ‰A/Bä¸¤ä¸ªsessionï¼ŒæŒ‰å¦‚ä¸‹é¡ºåºæ‰§è¡Œä¸¤ä¸ªäº‹åŠ¡
<img src="https://i.imgur.com/TeZjggw.jpg" alt="transaction" /></p>

<p>ç»“æœæ˜¯</p>

<ul>
<li>Bæ‰§è¡Œå®Œ4ä¹‹åè¿˜æ˜¯ä¸€åˆ‡æ­£å¸¸</li>
<li>Aæ‰§è¡Œ5çš„æ—¶å€™ï¼Œè¢«block</li>
<li>Bæ¥ç€æ‰§è¡Œ6ï¼ŒBæŠ¥æ­»é”ï¼ŒBå›æ»šï¼ŒAæ’å…¥æ•°æ®</li>
</ul>

<p><code>show engine innodb status</code>ä¸­å¯ä»¥çœ‹åˆ°æ­»é”ä¿¡æ¯ï¼Œè¿™é‡Œå…ˆä¸è´´ï¼Œå…ˆè§£é‡Šå‡ ç§é”çš„æ¦‚å¿µï¼Œå†æ¥ç†è§£æ­»é”è¿‡ç¨‹</p>

<h3 id="å…±äº«-s-é”-äº’æ–¥-x-é”">å…±äº«(S)é”/äº’æ–¥(X)é”</h3>

<ul>
<li>å…±äº«é”å…è®¸äº‹åŠ¡è¯»å–è®°å½•</li>
<li>äº’æ–¥é”å…è®¸äº‹åŠ¡è¯»å†™è®°å½•
è¿™ä¸¤ç§å…¶å®æ˜¯é”çš„æ¨¡å¼å¯ä»¥å’Œè¡Œé”ã€é—´éš™é”æ··æ­ï¼Œå¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰Sé”ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªäº‹åŠ¡èƒ½æŒæœ‰Xé”</li>
</ul>

<h3 id="æ„å‘é”">æ„å‘é”</h3>

<p>ä¸€ç§è¡¨é”(ä¹Ÿæ˜¯ä¸€ç§é”æ¨¡å¼)ï¼Œè¡¨æ˜æœ‰äº‹åŠ¡å³å°†ç»™å¯¹åº”è¡¨çš„è®°å½•åŠ Sæˆ–è€…Xé”ã€‚<code>SELECT ... LOCK IN SHARE MODE</code>ä¼šåœ¨ç»™è®°å½•åŠ Sé”ä¹‹å‰å…ˆç»™è¡¨åŠ ISé”ï¼Œ<code>SELECT ... FOR UPDATE</code>ä¼šåœ¨ç»™è®°å½•åŠ Xé”ä¹‹å‰ç»™è¡¨åŠ IXé”ã€‚
è¿™æ˜¯ä¸€ç§mysqlçš„é”ä¼˜åŒ–ç­–ç•¥ï¼Œå¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šæ„å‘é”çš„ä¼˜åŒ–ç‚¹åœ¨å“ªé‡Œï¼Œæ±‚å¤§ä½¬æŒ‡æ•™</p>

<p>ä¸¤ç§é”çš„å…¼å®¹æƒ…å†µå¦‚ä¸‹
<img src="https://i.imgur.com/LhhLp6t.jpg" alt="locks" /></p>

<h3 id="è¡Œé”">è¡Œé”</h3>

<p>å¾ˆç®€å•ï¼Œç»™å¯¹åº”è¡ŒåŠ é”ã€‚æ¯”å¦‚<code>update</code>ã€<code>select for update</code>ã€<code>delete</code>ç­‰éƒ½ä¼šç»™æ¶‰åŠåˆ°çš„è¡ŒåŠ ä¸Šè¡Œé”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡çš„æ“ä½œ</p>

<h3 id="é—´éš™é”">é—´éš™é”</h3>

<p>åœ¨RRéš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸ºäº†é˜²æ­¢å¹»è¯»ç°è±¡ï¼Œé™¤äº†ç»™è®°å½•æœ¬èº«ï¼Œè¿˜éœ€è¦ä¸ºè®°å½•ä¸¤è¾¹çš„é—´éš™åŠ ä¸Šé—´éš™é”ã€‚
æ¯”å¦‚åˆ—aä¸Šæœ‰ä¸€ä¸ªæ™®é€šç´¢å¼•ï¼Œå·²ç»æœ‰äº†1ã€5ã€10ä¸‰æ¡è®°å½•ï¼Œ<code>select * from t where a=5 for update</code>é™¤äº†ä¼šç»™5è¿™æ¡è®°å½•åŠ è¡Œé”ï¼Œè¿˜ä¼šç»™é—´éš™(1,5)å’Œ(5,10)åŠ ä¸Šé—´éš™é”ï¼Œé˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥å€¼ä¸º5çš„æ•°æ®é€ æˆå¹»è¯»ã€‚
å½“aä¸Šçš„æ™®é€šç´¢å¼•å˜æˆå”¯ä¸€ç´¢å¼•æ—¶ï¼Œä¸éœ€è¦é—´éš™é”ï¼Œå› ä¸ºå€¼å”¯ä¸€ï¼Œ<code>select * from t where a=5 for update</code>ä¸å¯èƒ½è¯»å‡ºä¸¤æ¡è®°å½•æ¥ã€‚</p>

<p>é—´éš™é”ç›¸äº’å…¼å®¹ï¼Œå› ä¸ºå¦‚æœäº’æ–¥ï¼Œäº‹åŠ¡AæŒæœ‰å·¦åŠæ®µ(1,5)ï¼Œäº‹åŠ¡BæŒæœ‰å³åŠæ®µ(1,10)ï¼Œé‚£ä¹ˆå½“å‰é¢é‚£ä¸ªä¾‹å­ä¸­a=5çš„è®°å½•è¢«åˆ é™¤æ—¶ï¼Œç†è®ºä¸Šå·¦å³ä¸¤ä¸ªé—´éš™é”å¾—åˆå¹¶æˆä¸€ä¸ªæ–°é”(1,10)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°çš„å¤§èŒƒå›´é”å±äºè°å‘¢ï¼Ÿæ‰€ä»¥é—´éš™é”ç›¸äº’å…¼å®¹ï¼Œä¸ç®¡æ˜¯Sé—´éš™é”è¿˜æ˜¯Xé—´éš™é”</p>

<h3 id="æ’å…¥æ„å‘é”">æ’å…¥æ„å‘é”</h3>

<p>æ’å…¥æ„å‘é”å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„é—´éš™é”ï¼Œä»å‰é¢å¯¹é—´éš™é”çš„æè¿°ä¸­å¯ä»¥å¾—çŸ¥ï¼Œä¸¤ä¸ªäº‹åŠ¡åœ¨çœŸæ­£insertä¹‹å‰å¯ä»¥åŒæ—¶æŒæœ‰ä¸€æ®µé—´éš™çš„é—´éš™é”ï¼Œé”ä¸ä½çœŸæ­£insertçš„è¿™ä¸ªåŠ¨ä½œã€‚çœŸæ­£insertä¹‹å‰ï¼Œmysqlè¿˜ä¼šå°è¯•è·å–å¯¹åº”è®°å½•çš„æ’å…¥æ„å‘é”ï¼Œè¡¨æ˜æœ‰åœ¨é—´éš™ä¸­æ’å…¥ä¸€ä¸ªå€¼çš„æ„å‘ã€‚
æ’å…¥æ„å‘é”å’Œé—´éš™é”äº’æ–¥ï¼Œæ¯”å¦‚äº‹åŠ¡1é”äº†(1,5)è¿™ä¸ªé—´éš™ï¼Œäº‹åŠ¡2å°±ä¸èƒ½è·å–åˆ°a=3çš„æ’å…¥æ„å‘é”ï¼Œæ‰€ä»¥éœ€è¦é”ç­‰å¾…ã€‚</p>

<h2 id="æ­»é”è¿‡ç¨‹åˆ†æ">æ­»é”è¿‡ç¨‹åˆ†æ</h2>

<p>æ¥ä¸‹æ¥å°±å¯ä»¥æ¥åˆ†æå‰é¢é‚£ä¸ªä¾‹å­ä¸­çš„æ­»é”è¿‡ç¨‹äº†ï¼Œå…ˆçœ‹<code>show engine innodb status</code></p>

<pre><code> *** (1) TRANSACTION:
TRANSACTION 5967, ACTIVE 8 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 9, OS thread handle 140528848688896, query id 537 192.168.128.1 root update
insert into t(a,b) values(0,'0')
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 64 page no 4 n bits 72 index uniq_a_b of table `t2`.`t` trx id 5967 lock_mode X locks gap before rec insert intention waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;

*** (2) TRANSACTION:
TRANSACTION 5968, ACTIVE 7 sec inserting
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 8, OS thread handle 140528848484096, query id 538 192.168.128.1 root update
insert into t(a,b) values(0,'0')
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 64 page no 4 n bits 72 index uniq_a_b of table `t2`.`t` trx id 5968 lock_mode X locks gap before rec
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 64 page no 4 n bits 72 index uniq_a_b of table `t2`.`t` trx id 5968 lock_mode X locks gap before rec insert intention waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;

*** WE ROLL BACK TRANSACTION (2)
</code></pre>

<p>session A(å³TRANSACTION 5967)æ­£åœ¨ç­‰å¾…è®°å½•(a=1,b=&lsquo;1&rsquo;)ä¹‹å‰çš„æ’å…¥æ„å‘é”ï¼Œsession B(å³TRANSACTION 5968)æŒæœ‰è®°å½•(a=1,b=&lsquo;1&rsquo;)ä¹‹å‰çš„é—´éš™é”ï¼Œå´ä¹Ÿåœ¨ç­‰å¾…é‚£ä¸ªæ’å…¥æ„å‘é”ã€‚è¿™è¯´çš„ä»€ä¹ˆç©æ„å„¿ï¼Œæ˜¯ä¸æ˜¯å¾ˆè¯¡å¼‚ï¼Ÿ</p>

<p>ä»å¤´å¼€å§‹åˆ†æè¿‡ç¨‹</p>

<ol>
<li>Aã€Båˆ†åˆ«beginï¼Œå¼€å§‹äº‹åŠ¡</li>
<li>Aå…ˆæ‰§è¡Œ<code>select * from t where a=0 and b='0' for update;</code>ï¼Œå…ˆåŠ äº†IXé”ï¼Œç„¶ååŸæœ¬æ„å›¾ä¸ºç»™(0, &lsquo;0&rsquo;)è¿™æ¡è®°å½•åŠ æ’ä»–è¡Œé”ï¼Œä½†æ˜¯è®°å½•ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å˜æˆäº†æ’ä»–é—´éš™é”(-âˆ,1)</li>
<li>Bå†æ‰§è¡Œ<code>select * from t where a=0 and b='0' for update;</code>ï¼Œä¹Ÿæ˜¯å…ˆåŠ äº†IXé”ï¼Œå› ä¸ºè®°å½•ä¸å­˜åœ¨ï¼Œæ‰€ä»¥åŠ ä¸Šäº†æ’ä»–é—´éš™é”(-âˆ,1)ï¼Œä½†æ˜¯ç”±äºé—´éš™é”ç›¸äº’å…¼å®¹ï¼Œæ‰€ä»¥æ²¡æœ‰block</li>
<li>Aæ‰§è¡Œ<code>insert into t(a,b) values(0,'0');</code>ï¼Œè¿™æ—¶å€™ï¼Œè¦å¼€å§‹çœŸæ­£insertäº†ï¼ŒAéœ€è¦è·å¾—(0,&lsquo;0&rsquo;)ä¸Šçš„æ’å…¥æ„å‘é”ï¼Œç”±äºå’ŒBæŒæœ‰çš„(-âˆ,1)æ’ä»–æ„å‘é”å†²çªï¼Œæ‰€ä»¥é”ç­‰å¾…ï¼Œè¿›å…¥è®°å½•(0,&lsquo;0&rsquo;)çš„é”ç­‰å¾…é˜Ÿåˆ—ï¼ˆè™½ç„¶è®°å½•å¹¶ä¸å­˜åœ¨ï¼‰</li>
<li>Bæ‰§è¡Œ<code>insert into t(a,b) values(0,'0');</code>ï¼Œè¦è·å–æ’å…¥æ„å‘é”ï¼Œå‘ç°è™½ç„¶Bè‡ªå·±æ˜¯æŒæœ‰(-âˆ,1)çš„æ’ä»–é—´éš™é”ï¼Œä½†æ˜¯Aä¹Ÿæœ‰ï¼Œæ‰€ä»¥è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç­‰å¾…Aé‡Šæ”¾</li>
<li>å®ï¼Œæ­»é”å‘ç”Ÿ</li>
</ol>

<p>æ­»é”ä¿¡æ¯è§£è¯»</p>

<p>äº‹åŠ¡1(TRANSACTION 5967)ï¼Œç­‰å¾…è·å¾—é”index uniq_a_b of table <code>t2</code>.<code>t</code> trx id 5967 lock_mode X locks gap before rec insert intention waitingï¼Œå³åœ¨å”¯ä¸€ç´¢å¼•<code>uniq_a_b</code>ä¸Šçš„æ’å…¥æ„å‘é”(lock_mode X locks gap before rec insert intention)
é”çš„è¾¹ç•Œä¸º</p>

<pre><code> 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;
</code></pre>

<p>è¡¨æ˜ä¸¤è¡Œè®°å½•</p>

<ul>
<li>0å’Œ1è¡¨ç¤ºuniq_a_bä¸Šçš„å€¼ï¼Œa=1ï¼Œb=0x31ï¼ˆå³&rsquo;1&rsquo;çš„asciiç ï¼‰</li>
<li>a=1,b=&lsquo;1&rsquo;å¯¹åº”çš„ä¸»é”®id=1ï¼Œå› ä¸ºinnodbçš„ç´¢å¼•ç»“æ„å†³å®šçš„ï¼ŒäºŒçº§ç´¢å¼•(éä¸»é”®ç´¢å¼•)æŒ‡å‘ä¸»é”®ç´¢å¼•ï¼Œä¸»é”®ç´¢å¼•å†æŒ‡å‘æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦ç»™ä¸»é”®åŠ ç´¢å¼•
è‡³äºintå€¼æŒ‰ä½æˆ–ä¸Šçš„0x80000000å°±ä¸æ˜¯å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆäº†ï¼Œéœ€è¦å¤§ä½¬è§£è¯»</li>
</ul>

<p>äº‹åŠ¡2(TRANSACTION 5968)ï¼ŒæŒæœ‰é—´éš™é”index uniq_a_b of table <code>t2</code>.<code>t</code> trx id 5968 lock_mode X locks gap before recï¼Œç­‰å¾…æ’å…¥æ„å‘é”index uniq_a_b of table <code>t2</code>.<code>t</code> trx id 5968 lock_mode X locks gap before rec insert intentionï¼Œæ‰€ä»¥æ­»é”å‘ç”Ÿã€‚</p>

<p>åŸåˆ™ä¸Šæ˜¯innodbå¼•æ“åˆ¤æ–­å“ªä¸ªäº‹åŠ¡å›æ»šä»£ä»·å°å°±å›æ»šå“ªä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯å…·ä½“è¯„åˆ¤æ ‡å‡†ä¸æ˜¯å¾ˆæ¸…æ¥šï¼ˆå†ä¸€æ¬¡éœ€è¦å¤§ä½¬ï¼‰ï¼Œè¿™é‡Œinnodbé€‰æ‹©äº†å›æ»šäº‹åŠ¡2ã€‚è‡³æ­¤ï¼Œæ­»é”è¿‡ç¨‹åˆ†æå®Œæ¯•</p>

<h2 id="one-more-thing">One More Thing</h2>

<p>è¿˜æ²¡å®Œã€‚ã€‚ã€‚æœ‰ä¸ªç¥å¥‡çš„ç°è±¡æ˜¯ï¼Œå¦‚æœè¡¨ç»“æ„å˜æˆ</p>

<pre><code class="language-sql">create table t (
    id int not null primary key AUTO_INCREMENT,
    a int not null default 0,
    b varchar(10) not null default '',
    c varchar(10) not null default '',
    unique key uniq_c(c),
    unique key uniq_a_b(a,b)
);
insert into t(a,b,c) values(1,1,1);
</code></pre>

<p>åªæ˜¯æŠŠcä¸Šçš„å”¯ä¸€ç´¢å¼•<code>uniq_c</code>æ”¾åˆ°äº†<code>uniq_a_b</code>å‰é¢ï¼Œé‚£ä¹ˆæœ€åçš„æ­»é”ä¿¡æ¯å°±å˜äº†ï¼</p>

<pre><code> *** (1) TRANSACTION:
TRANSACTION 5801, ACTIVE 5 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 4 lock struct(s), heap size 1136, 3 row lock(s), undo log entries 1
MySQL thread id 5, OS thread handle 140528848688896, query id 380 192.168.128.1 root update
insert into t2(a,b) values(0,'0')
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 56 page no 5 n bits 72 index uniq_a_b of table `t2`.`t2` trx id 5801 lock_mode X locks gap before rec insert intention waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;

*** (2) TRANSACTION:
TRANSACTION 5802, ACTIVE 4 sec inserting
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 6, OS thread handle 140528848484096, query id 381 192.168.128.1 root update
insert into t2(a,b) values(0,'0')
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 56 page no 5 n bits 72 index uniq_a_b of table `t2`.`t2` trx id 5802 lock_mode X locks gap before rec
Record lock, heap no 2 PHYSICAL RECORD: n_fields 3; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 1; hex 31; asc 1;;
 2: len 4; hex 80000001; asc     ;;

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 56 page no 4 n bits 72 index uniq_c of table `t2`.`t2` trx id 5802 lock mode S waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 2; compact format; info bits 0
 0: len 0; hex ; asc ;;
 1: len 4; hex 80000002; asc     ;;

*** WE ROLL BACK TRANSACTION (2)
</code></pre>

<p>äº‹åŠ¡2ç­‰å¾…çš„é”ç”±å‰é¢çš„æ’å…¥æ„å‘é”å˜æˆäº†å…±äº«é”ã€‚ä»€ä¹ˆé¬¼ï¼Ÿ
ç”±äºæ²¡çœ‹è¿‡æºç ï¼Œåªèƒ½æ ¹æ®ç°è±¡å€’æ¨ï¼šå› ä¸ºè¡¨ç»“æ„ä¸Šcçš„å”¯ä¸€ç´¢å¼•åœ¨(a,b)å‰é¢ï¼Œè€Œæ’å…¥çš„æ—¶å€™æ²¡æŒ‡å®šcçš„å€¼ï¼Œç”¨çš„é»˜è®¤å€¼0ï¼Œinnodbéœ€è¦å…ˆå»æŸ¥ä¸€ä¸‹æœ‰æ²¡æœ‰0è¿™æ¡è®°å½•ï¼Œæœ‰çš„è¯å°±è¦æŠ¥å”¯ä¸€é”®å†²çªäº†ï¼Œæ‰€ä»¥å…ˆè¦åŠ Sé”ï¼Œä½†æ˜¯åœ¨(0,&lsquo;0&rsquo;)è¿™æ¡è®°å½•ä¸Šå·²ç»æœ‰äº†IXé”ï¼Œçœ‹ä¸€ä¸‹å‰é¢çš„å…¼å®¹æ€§çŸ©é˜µï¼ŒSé”å’ŒIXé”äº’æ–¥ï¼Œæ‰€ä»¥ä¹Ÿåªèƒ½é”ç­‰å¾…</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>çœ‹ä¼¼ä¸€å¥ç®€å•çš„selectå’Œinsertï¼Œåº•ä¸‹è®¾è®¡éå¸¸å¤æ‚çš„é”æœºåˆ¶ï¼Œç†è§£è¿™äº›é”æœºåˆ¶æœ‰åˆ©äºå†™å‡ºé«˜æ•ˆçš„SQL(è‡³å°‘æ˜¯æ­£ç¡®çš„ğŸ˜‚)</p>

<p>é—ç•™é—®é¢˜ï¼š</p>

<ol>
<li>æ„å‘é”çš„ä¼˜åŒ–ç‚¹æ˜¯å“ª</li>
<li>é”ä¿¡æ¯é‡Œï¼Œè¡Œè®°å½•æŒ‰ä½æˆ–ä¸Šçš„0x80000000æ˜¯å•¥</li>
<li>é”äº’æ–¥çš„åˆ¤å®šé¡ºåºï¼Œåœºæ™¯1ä¸­ï¼Œ(0,&lsquo;0&rsquo;)ä¸Šæœ‰å…¼å®¹çš„é—´éš™é”ï¼Œä¹Ÿæœ‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„é”ï¼Œå…ˆåˆ¤å®šå“ªä¸ªï¼Ÿ</li>
<li>innodbè®¡ç®—äº‹åŠ¡å›æ»šä»£ä»·çš„ç®—æ³•</li>
</ol>

<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>

<ul>
<li><a href="http://hedengcheng.com/?p=771">http://hedengcheng.com/?p=771</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-insert-intention-locks">https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-insert-intention-locks</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-next-key-locking.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-next-key-locking.html</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-information-schema-understanding-innodb-locking.html">https://dev.mysql.com/doc/refman/5.7/en/innodb-information-schema-understanding-innodb-locking.html</a></li>
</ul>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">hbprotoss</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2019-03-03</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh"><img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 3.0 æœªæœ¬åœ°åŒ–ç‰ˆæœ¬è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯ã€‚</span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/database/">Database</a>
          
          <a href="/tags/mysql/">MySQL</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/%E8%A1%A5%E5%AE%8Ctcp-backlog/">
            <span class="next-text nav-default">è¡¥å®ŒTCP Backlog</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'hbprotoss';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://weibo.com/hbprotoss" class="iconfont icon-weibo" title="weibo"></a>
  <a href="http://hbprotoss.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">hbprotoss</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>








</body>
</html>
