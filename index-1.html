<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>hbprotoss的博客 (old posts, page 1) | hbprotoss的博客</title>
<link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="assets/css/code.css" rel="stylesheet" type="text/css">
<link href="assets/css/colorbox.css" rel="stylesheet" type="text/css">
<link href="assets/css/theme.css" rel="stylesheet" type="text/css">
<link href="assets/css/blog.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://hbprotoss.github.io/index-1.html">
<link rel="prev" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<div class="blog-masthead">
    <div class="container">
<!-- This keeps the margins nice -->
        <nav class="blog-nav" role="navigation"><a href="index.html" class="blog-nav-item">Home</a>
            <a href="archive.html" class="blog-nav-item">Archives</a>
            <a href="categories/index.html" class="blog-nav-item">Tags</a>
            <a href="rss.xml" class="blog-nav-item">RSS</a>

            

                
                
                    
                
            
        </nav>
</div>
<!-- /.container -->
</div>
<!-- End of Menubar -->

<div class="container" id="content" role="main">
    <div class="body-content">
        <div class="blog-header">
            <h1 class="blog-title">
                <a href="http://hbprotoss.github.io/">

                    <span id="blog-title">hbprotoss的博客</span>
                </a>
            </h1>
            <p class="lead blog-description"></p>
            
        </div>
        <!--Body content-->
        <div class="row">
            <div class="col-sm-8 blog-main">
                

<div class="postindex">
    <article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/linuxxia-bian-yi-lian-jie-dong-tai-ku.html" class="u-url">Linux下编译链接动态库</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/linuxxia-bian-yi-lian-jie-dong-tai-ku.html" rel="bookmark"><time class="published dt-published" datetime="2013-10-08T09:18:31+08:00" title="2013-10-08 09:18">2013-10-08 09:18</time></a></p>
                <p class="commentline">
        
    <a href="posts/linuxxia-bian-yi-lian-jie-dong-tai-ku.html#disqus_thread" data-disqus-identifier="cache/posts/linuxxia-bian-yi-lian-jie-dong-tai-ku.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>记录下Linux下编译和链接动态库的过程。</p>
<h3>一、 编写动态库</h3>
<p>头文件so.h：  </p>
<pre class="code literal-block"><span></span><span class="cp">#ifndef  SO_H</span>
<span class="cp">#define  SO_H</span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>


<span class="cp">#endif  </span><span class="cm">/*SO_H*/</span><span class="cp"></span>
</pre>


<p>实现文件so.c：</p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">"so.h"</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre>


<h3>二、编译动态库</h3>
<pre class="code literal-block"><span></span>gcc so.c -fPIC -shared -o libtest.so
</pre>


<p>解释一下各个参数含义：</p>
<ol>
<li>-fPIC：生成位置无关代码(<a href="http://en.wikipedia.org/wiki/Position-independent_code">Position Independent Code</a>)，只有生成PIC才能通过虚拟页映射达到可执行代码在进程间共享，从而节省内存的目的。</li>
<li>说明我们要生成的是动态库so(Shared Object)文件，从而进行动态链接。</li>
</ol>
<p>通过<code>nm -g libtest.so</code>可以看到，导出符号表中已经有<code>add</code>这个符号了：</p>
<pre class="code literal-block"><span></span>$ nm -g libtest.so 
<span class="m">0000000000000670</span> T add
<span class="m">0000000000201030</span> B __bss_start
                 w __cxa_finalize@@GLIBC_2.2.5
<span class="m">0000000000201030</span> D _edata
<span class="m">0000000000201038</span> B _end
<span class="m">0000000000000684</span> T _fini
                 w __gmon_start__
<span class="m">0000000000000540</span> T _init
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 w _Jv_RegisterClasses
</pre>


<h3>三、使用动态库</h3>
<h4>1. 隐式链接(编译时链接)</h4>
<p>编写主程序main.c：</p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">"so.h"</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>


<p>使用<code>gcc main.c -L. -ltest -o test</code>进行编译。</p>
<ul>
<li>-L：添加库文件的搜索路径</li>
<li>-l：指定需要链接的库。该名称是处在头lib和后缀.so中的名称，如上动态库libtest.so的l参数为-l test</li>
</ul>
<p>此时通过<code>readelf test -d</code>已经能看到生成的可执行文件test的Dynamic section里依赖libtest.so了</p>
<pre class="code literal-block"><span></span>$ readelf <span class="nb">test</span> -d

Dynamic section at offset 0xe18 contains <span class="m">25</span> entries:
  Tag        Type                         Name/Value
 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libtest.so<span class="o">]</span>
 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libc.so.6<span class="o">]</span>
......
</pre>


<p>dynamic symbols中也有一个undefined symbol(add)</p>
<pre class="code literal-block"><span></span>$ nm -D <span class="nb">test</span> 
                 U add
<span class="m">0000000000601048</span> B __bss_start
<span class="m">0000000000601048</span> D _edata
<span class="m">0000000000601050</span> B _end
00000000004007b4 T _fini
                 w __gmon_start__
<span class="m">0000000000400578</span> T _init
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 w _Jv_RegisterClasses
                 U __libc_start_main
                 U <span class="nb">printf</span>
</pre>


<p>在执行隐式链接的程序之前要注意设置<code>LD_LIBRARY_PATH</code>环境变量，或者把前面生成的libtest.so复制到系统路径下，否则会找不到动态库。</p>
<pre class="code literal-block"><span></span>$ ./test 
./test: error <span class="k">while</span> loading shared libraries: libtest.so: cannot open shared object file: No such file or directory

$ <span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.

$ ./test 
<span class="m">3</span>
</pre>


<h4>2. 显式链接(运行时链接)</h4>
<p>编写主程序dyn_main.c</p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">dl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">add</span><span class="p">)(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">);</span>
    <span class="n">dl</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span> <span class="s">"./libtest.so"</span><span class="p">,</span> <span class="n">RTLD_LAZY</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"so loading error.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">add</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span><span class="n">dlsym</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span> <span class="s">"add"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">dlerror</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"fun load error.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>


<p>使用<code>gcc dyn_main.c -ldl -o dyn_test</code>编译。</p>
<p>这时通过<code>readelf dyn_test -d</code>可以发现，dyn_test不依赖libtest.so：</p>
<pre class="code literal-block"><span></span>$ readelf dyn_test -d

Dynamic section at offset 0xe18 contains <span class="m">25</span> entries:
  Tag        Type                         Name/Value
 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libdl.so.2<span class="o">]</span>
 0x0000000000000001 <span class="o">(</span>NEEDED<span class="o">)</span>             Shared library: <span class="o">[</span>libc.so.6<span class="o">]</span>
......
</pre>


<p>dyn_test的dynamic symbols中也没有add：</p>
<pre class="code literal-block"><span></span>$ nm -D dyn_test 
                 U dlerror
                 U dlopen
                 U dlsym
                 w __gmon_start__
                 w _ITM_deregisterTMCloneTable
                 w _ITM_registerTMCloneTable
                 w _Jv_RegisterClasses
                 U __libc_start_main
                 U <span class="nb">printf</span>
                 U puts
</pre>


<p>运行程序也不需要设置<code>LD_LIBRARY_PATH</code>环境变量</p>
<pre class="code literal-block"><span></span>$ ./dyn_test 
<span class="m">3</span>
</pre>


<hr>
<p>参考资料：</p>
<ol>
<li><a href="http://hi.baidu.com/linuxlife/item/ed8e5d0c6e86b491a2df4366">Linux动态库的编译与使用 转载</a></li>
<li><a href="http://os.51cto.com/art/201003/186246.htm">详细分析Linux动态库的使用方式</a></li>
<li><a href="http://stackoverflow.com/questions/34732/how-do-i-list-the-symbols-in-a-so-file">How do I list the symbols in a .so file</a></li>
<li><a href="http://stackoverflow.com/questions/10480657/import-names-in-elf-binary">Import names in ELF binary</a></li>
</ol>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/cyu-yan-hong-de-te-shu-yong-fa-he-ji-ge-keng.html" class="u-url">C语言宏的特殊用法和几个坑</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/cyu-yan-hong-de-te-shu-yong-fa-he-ji-ge-keng.html" rel="bookmark"><time class="published dt-published" datetime="2013-07-13T14:25:31+08:00" title="2013-07-13 14:25">2013-07-13 14:25</time></a></p>
                <p class="commentline">
        
    <a href="posts/cyu-yan-hong-de-te-shu-yong-fa-he-ji-ge-keng.html#disqus_thread" data-disqus-identifier="cache/posts/cyu-yan-hong-de-te-shu-yong-fa-he-ji-ge-keng.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>总结一下C语言中宏的一些特殊用法和几个容易踩的坑。由于本文主要参考GCC文档，某些细节（如宏参数中的空格是否处理之类）在别的编译器可能有细微差别，请参考相应文档。</p>
<h3>宏基础</h3>
<p>宏仅仅是在C预处理阶段的一种文本替换工具，编译完之后对二进制代码不可见。基本用法如下：</p>
<h4>1. 标示符别名</h4>
<pre class="code literal-block"><span></span><span class="cp">#define BUFFER_SIZE 1024</span>
</pre>


<p>预处理阶段，<code>foo = (char *) malloc (BUFFER_SIZE);</code>会被替换成<code>foo = (char *) malloc (1024);</code></p>
<p>宏体换行需要在行末加反斜杠\</p>
<pre class="code literal-block"><span></span><span class="cp">#define NUMBERS 1, \</span>
<span class="cp">                2, \</span>
<span class="cp">                3</span>
</pre>


<p>预处理阶段<code>int x[] = { NUMBERS };</code>会被扩展成<code>int x[] = { 1, 2, 3 };</code></p>
<h4>2. 宏函数</h4>
<p>宏名之后带括号的宏被认为是宏函数。用法和普通函数一样，只不过在预处理阶段，宏函数会被展开。优点是没有普通函数保存寄存器和参数传递的开销，展开后的代码有利于CPU cache的利用和指令预测，速度快。缺点是可执行代码体积大。</p>
<pre class="code literal-block"><span></span><span class="cp">#define min(X, Y)  ((X) &lt; (Y) ? (X) : (Y))</span>
</pre>


<p><code>y = min(1, 2);</code>会被扩展成<code>y = ((1) &lt; (2) ? (1) : (2));</code></p>
<hr>
<h3>宏特殊用法</h3>
<h4>1. 字符串化(Stringification)</h4>
<p>在宏体中，如果宏参数前加个<code>#</code>，那么在宏体扩展的时候，宏参数会被扩展成字符串的形式。如：</p>
<pre class="code literal-block"><span></span><span class="cp">#define WARN_IF(EXP) \</span>
<span class="cp">     do { if (EXP) \</span>
<span class="cp">             fprintf (stderr, "Warning: " #EXP "\n"); } \</span>
<span class="cp">     while (0)</span>
</pre>


<p><code>WARN_IF (x == 0);</code>会被扩展成：</p>
<pre class="code literal-block"><span></span><span class="k">do</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Warning: "</span> <span class="s">"x == 0"</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="p">}</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre>


<p>这种用法可以用在assert中，如果断言失败，可以将失败的语句输出到反馈信息中</p>
<h4>2. 连接(Concatenation)</h4>
<p>在宏体中，如果宏体所在标示符中有<code>##</code>，那么在宏体扩展的时候，宏参数会被直接替换到标示符中。如：</p>
<pre class="code literal-block"><span></span><span class="cp">#define COMMAND(NAME)  { #NAME, NAME ## _command }</span>

<span class="k">struct</span> <span class="n">command</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="p">};</span>
</pre>


<p>在宏扩展的时候</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="n">command</span> <span class="n">commands</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="n">COMMAND</span> <span class="p">(</span><span class="n">quit</span><span class="p">),</span>
    <span class="n">COMMAND</span> <span class="p">(</span><span class="n">help</span><span class="p">),</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre>


<p>会被扩展成：</p>
<pre class="code literal-block"><span></span><span class="k">struct</span> <span class="n">command</span> <span class="n">commands</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="s">"quit"</span><span class="p">,</span> <span class="n">quit_command</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">"help"</span><span class="p">,</span> <span class="n">help_command</span> <span class="p">},</span>
    <span class="p">...</span>
<span class="p">};</span>
</pre>


<p>这样就节省了大量时间，提高效率。</p>
<hr>
<h3>几个坑</h3>
<h4>1. 语法问题</h4>
<p>由于是纯文本替换，C预处理器不对宏体做任何语法检查，像缺个括号、少个分号神马的预处理器是不管的。这里要格外小心，由此可能引出各种奇葩的问题，一下还很难找到根源。</p>
<h4>2. 算符优先级问题</h4>
<p>不仅宏体是纯文本替换，宏参数也是纯文本替换。有以下一段简单的宏，实现乘法：</p>
<pre class="code literal-block"><span></span><span class="cp">#define MULTIPLY(x, y) x * y</span>
</pre>


<p><code>MULTIPLY(1, 2)</code>没问题，会正常展开成<code>1 * 2</code>。有问题的是这种表达式<code>MULTIPLY(1+2, 3)</code>，展开后成了<code>1+2 * 3</code>，显然优先级错了。</p>
<p>在宏体中，给引用的参数加个括号就能避免这问题。</p>
<pre class="code literal-block"><span></span><span class="cp">#define MULTIPLY(x, y) (x) * (y)</span>
</pre>


<p><code>MULTIPLY(1+2, 3)</code>就会被展开成<code>(1+2) * (3)</code>，优先级正常了。</p>
<p>其实这个问题和下面要说到的某些问题都属于由于纯文本替换而导致的语义破坏问题，要格外小心。</p>
<h4>3. 分号吞噬问题</h4>
<p>有如下宏定义：</p>
<pre class="code literal-block"><span></span><span class="cp">#define SKIP_SPACES(p, limit)  \</span>
<span class="cp">     { char *lim = (limit);         \</span>
<span class="cp">       while (p &lt; lim) {            \</span>
<span class="cp">         if (*p++ != ' ') {         \</span>
<span class="cp">           p--; break; }}}</span>
</pre>


<p>假设有如下一段代码：</p>
<pre class="code literal-block"><span></span><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
   <span class="n">SKIP_SPACES</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">lim</span><span class="p">);</span>
<span class="k">else</span> <span class="p">...</span>
</pre>


<p>一编译，GCC报<code>error: ‘else’ without a previous ‘if’</code>。原来这个看似是一个函数的宏被展开后是一段大括号括起来的代码块，加上分号之后这个if逻辑块就结束了，所以编译器发现这个else没有对应的if。</p>
<p>这个问题一般用<code>do ... while(0)</code>的形式来解决：</p>
<pre class="code literal-block"><span></span><span class="cp">#define SKIP_SPACES(p, limit)     \</span>
<span class="cp">     do { char *lim = (limit);         \</span>
<span class="cp">          while (p &lt; lim) {            \</span>
<span class="cp">            if (*p++ != ' ') {         \</span>
<span class="cp">              p--; break; }}}          \</span>
<span class="cp">     while (0)</span>
</pre>


<p>展开后就成了</p>
<pre class="code literal-block"><span></span><span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">do</span> <span class="p">...</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">else</span> <span class="p">...</span>
</pre>


<p>这样就消除了分号吞噬问题。</p>
<p>这个技巧在Linux内核源码里很常见，比如这个置位宏<code>#define SET_REG_BIT(reg, bit)              do { (reg |= (1 &lt;&lt; (bit))); } while (0)</code>(位于arch/mips/include/asm/mach-pnx833x/gpio.h)</p>
<h4>4. 宏参数重复调用</h4>
<p>有如下宏定义：</p>
<pre class="code literal-block"><span></span><span class="cp">#define min(X, Y)  ((X) &lt; (Y) ? (X) : (Y))</span>
</pre>


<p>当有如下调用时<code>next = min (x + y, foo (z));</code>，宏体被展开成<code>next = ((x + y) &lt; (foo (z)) ? (x + y) : (foo (z)));</code>，可以看到，<code>foo(z)</code>被重复调用了两次，做了重复计算。更严重的是，如果foo是不可重入的(foo内修改了全局或静态变量)，程序会产生逻辑错误。</p>
<p>所以，尽量不要在宏参数中传入函数调用。</p>
<h4>5. 对自身的递归引用</h4>
<p>有如下宏定义：</p>
<pre class="code literal-block"><span></span><span class="cp">#define foo (4 + foo)</span>
</pre>


<p>按前面的理解，<code>(4 + foo)</code>会展开成<code>(4 + (4 + foo))</code>，然后一直展开下去，直至内存耗尽。但是，预处理器采取的策略是<strong><em>只展开一次</em></strong>。也就是说，<code>foo</code>只会展开成<code>(4 + foo)</code>，而展开之后<code>foo</code>的含义就要根据上下文来确定了。</p>
<p>对于以下的交叉引用，宏体也只会展开一次。</p>
<pre class="code literal-block"><span></span><span class="cp">#define x (4 + y)</span>
<span class="cp">#define y (2 * x)</span>
</pre>


<p><code>x</code>展开成<code>(4 + y) -&gt; (4 + (2 * x))</code>，<code>y</code>展开成<code>(2 * x) -&gt; (2 * (4 + y))</code>。</p>
<p><strong>注意，这是极不推荐的写法，程序可读性极差。</strong></p>
<h4>6. 宏参数预处理</h4>
<p>宏参数中若包含另外的宏，那么宏参数在被代入到宏体之前会做一次完全的展开，除非宏体中含有<code>#</code>或<code>##</code>。</p>
<p>有如下宏定义：</p>
<pre class="code literal-block"><span></span><span class="cp">#define AFTERX(x) X_ ## x</span>
<span class="cp">#define XAFTERX(x) AFTERX(x)</span>
<span class="cp">#define TABLESIZE 1024</span>
<span class="cp">#define BUFSIZE TABLESIZE</span>
</pre>


<ul>
<li>
<code>AFTERX(BUFSIZE)</code>会被展开成<code>X_BUFSIZE</code>。因为宏体中含有<code>##</code>，宏参数直接代入宏体。</li>
<li>
<code>XAFTERX(BUFSIZE)</code>会被展开成<code>X_1024</code>。因为<code>XAFTERX(x)</code>的宏体是<code>AFTERX(x)</code>，并没有<code>#</code>或<code>##</code>，所以<code>BUFSIZE</code>在代入前会被完全展开成<code>1024</code>，然后才代入宏体，变成<code>X_1024</code>。</li>
</ul>
<p>-EOF-</p>
<hr>
<p>参考资料：</p>
<p><a href="http://gcc.gnu.org/onlinedocs/cpp/Macros.html">http://gcc.gnu.org/onlinedocs/cpp/Macros.html</a></p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/python-descriptor.html" class="u-url">Python descriptor</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/python-descriptor.html" rel="bookmark"><time class="published dt-published" datetime="2013-06-12T12:31:54+08:00" title="2013-06-12 12:31">2013-06-12 12:31</time></a></p>
                <p class="commentline">
        
    <a href="posts/python-descriptor.html#disqus_thread" data-disqus-identifier="cache/posts/python-descriptor.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>一次偶然发现，Python的对象竟然可以在运行期动态添加类定义时没有的属性，这又颠覆了我对Python OO机制的理解。Google了一把，顺着<code>__dict__</code>属性一路找到descriptor，揭开了隐藏在Python对象之后的内幕。</p>
<p>本文主要记录Python的descriptor机制，以及其在Python对象的属性、方法绑定上的作用。</p>
<p>先从本文的始作俑者，运行期动态添加对象属性开始讲起。</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">'value'</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'function f'</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">a</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
</pre>


<p>以上代码奇迹般的没有报错，而且还输出了1。这肯定会让写过C++/Java代码的童鞋表示吃惊，Python变量类型动态也就不稀奇了，对象属性还能动态添加的？Python到底在背后做了什么？</p>
<h3>神奇的__dict__</h3>
<p>在<code>a.attr = 1</code>前后分别加上一行<code>print(a.__dict__)</code>就会得到如下结果:  </p>
<pre class="code literal-block"><span></span><span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="s1">'value'</span><span class="p">}</span>  
<span class="mi">1</span>  
<span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="s1">'value'</span><span class="p">,</span> <span class="s1">'attr'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> 
</pre>


<p>显而易见，我们在运行期定义的属性和类定义时定义的属性都被放在了<code>__dict__</code>里。</p>
<p>到这里有人可能就有疑问了，Python里的一切不都是对象麽？为什么成员函数<code>__init__</code>、<code>f</code>不在这个字典里？</p>
<p>看看<code>A.__dict__</code>里有什么就明白了：  </p>
<pre class="code literal-block"><span></span><span class="p">{</span><span class="s1">'__dict__'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">attribute</span> <span class="s1">'__dict__'</span> <span class="n">of</span> <span class="s1">'A'</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s1">'__doc__'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
 <span class="s1">'__init__'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">__main__</span><span class="o">.</span><span class="fm">__init__</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s1">'__module__'</span><span class="p">:</span> <span class="s1">'__main__'</span><span class="p">,</span>
 <span class="s1">'__weakref__'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">attribute</span> <span class="s1">'__weakref__'</span> <span class="n">of</span> <span class="s1">'A'</span> <span class="n">objects</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s1">'f'</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">__main__</span><span class="o">.</span><span class="n">f</span><span class="o">&gt;</span><span class="p">}</span>
</pre>


<p>这时才恍然大悟，如果成员变量看做是对象的属性，那么成员函数就应该看成是类的属性，被全部对象共享嘛。</p>
<p>更精确地讲，以<code>object.attribute</code>访问一个对象的属性时，属性的搜索顺序为：</p>
<ol>
<li>对象自身，<code>object.__dict__</code>
</li>
<li>对象类型，<code>object.__class__.__dict__</code>
</li>
<li>对象类型的基类，<code>object.__class__.__bases__</code>中的所有<code>__dict__</code>。注意，当多重继承的情况下有菱形继承的时候，Python会根据MRO确定的顺序进行搜索。关于MRO(Method Resolution Order)是什么有时间专门写一篇文章总结一下。</li>
</ol>
<p>当以上三个步骤都没有找到要访问的属性的时候Python就只能抛出<code>AttributeError</code>异常了。</p>
<h3>Descriptor是什么</h3>
<p>讲了这么多，貌似跟descriptor半毛钱关系没有嘛。别急，接着往下看。</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">RevealAccess</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initval</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">'var'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">initval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">'Retrieving'</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">print</span> <span class="s1">'Updating'</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
</pre>


<p>来测试一下这个类</p>
<pre class="code literal-block"><span></span><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">RevealAccess</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">'var "x"'</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span>
<span class="n">Retrieving</span> <span class="n">var</span> <span class="s2">"x"</span>
<span class="mi">10</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">Updating</span> <span class="n">var</span> <span class="s2">"x"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">x</span>
<span class="n">Retrieving</span> <span class="n">var</span> <span class="s2">"x"</span>
<span class="mi">20</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">y</span>
<span class="mi">5</span>
</pre>


<p>这个<code>RevealAccess</code>的对象就是一个descriptor，其作用就是在存取变量的时候做了一个hook。访问属性<code>m.x</code>就是调用<code>__get__</code>方法，设置属性值就是调用<code>__set__</code>方法。还可以有一个<code>__delete__</code>方法，在<code>del m.x</code>时被调用。</p>
<p>只要一个类定义了以上三种方法，其对象就是一个descriptor。我们把同时定义<code>__get__</code>和<code>__set__</code>方法的descriptor叫做<strong>data descriptor</strong>，把只定义<code>__get__</code>方法的叫<strong>non-data descriptor</strong></p>
<h3>Method binding</h3>
<p>有了以上两个概念，我们就能讨论Python的方法绑定了。</p>
<p>还记得讨论<code>__dict__</code>时的成员函数<code>f</code>吗？按照我们的推测，<code>A.__dict__['f']</code>应该和<code>a.f</code>是一个东西。但是！！！</p>
<pre class="code literal-block"><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">A</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'f'</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">function</span> <span class="n">__main__</span><span class="o">.</span><span class="n">f</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">f</span>
<span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">A</span><span class="o">.</span><span class="n">f</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">A</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f9d69cc5950</span><span class="o">&gt;&gt;</span>
</pre>


<p>这两个显然不是一个东西，一个是<code>function</code>，一个是<code>bound method</code>。这是什么情况？淡定，看下面</p>
<pre class="code literal-block"><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">A</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s1">'f'</span><span class="p">]</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">A</span><span class="o">.</span><span class="n">f</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">A</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f9d69cc5950</span><span class="o">&gt;&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">f</span>
<span class="o">&lt;</span><span class="n">bound</span> <span class="n">method</span> <span class="n">A</span><span class="o">.</span><span class="n">f</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">__main__</span><span class="o">.</span><span class="n">A</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f9d69cc5950</span><span class="o">&gt;&gt;</span>
</pre>


<p>这下放心了吧:D</p>
<p>其实，类的成员函数就是一个descriptor，在实例化对象a的时候，Python就做了这么一个过程(伪码，详见Objects/funcobject.c)：<code>a.f = A.__dict__['f'].__get__(a, A)</code></p>
<p>纯Python模拟的函数对象就像这样：</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">.</span> <span class="o">.</span> <span class="o">.</span>
    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s2">"Simulate func_descr_get() in Objects/funcobject.c"</span>
        <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="p">)</span>
</pre>


<p>然后就好理解<code>staticmethod</code>和<code>classmethod</code>这两个decorator了吧。<code>staticmethod</code>无视了传入的第一个self参数，<code>classmethod</code>手工加了一个类对象参数进去。它们的纯Python模拟就像下面所示：</p>
<pre class="code literal-block"><span></span><span class="k">class</span> <span class="nc">StaticMethod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="s2">"Emulate PyStaticMethod_Type() in Objects/funcobject.c"</span>

 <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

 <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">objtype</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span>

<span class="k">class</span> <span class="nc">ClassMethod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
     <span class="s2">"Emulate PyClassMethod_Type() in Objects/funcobject.c"</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>

     <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
               <span class="n">klass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
          <span class="k">def</span> <span class="nf">newfunc</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
               <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">newfunc</span>
</pre>


<hr>
<p>研究Python的底层实现是个很有意思的事，至少能让我在使用Python时更加放心：）</p>
<p>全文完</p>
<hr>
<p>参考资料：</p>
<ol>
<li>How-To Guide for Descriptors: <a href="http://users.rcn.com/python/download/Descriptor.htm">http://users.rcn.com/python/download/Descriptor.htm</a>
</li>
<li>Python Attributes and Methods: <a href="http://www.cafepy.com/article/python_attributes_and_methods/python_attributes_and_methods.html">http://www.cafepy.com/article/python_attributes_and_methods/python_attributes_and_methods.html</a>
</li>
<li>《Expert Python Programming》,Tarek Ziadé: <a href="http://book.douban.com/subject/3285148/">http://book.douban.com/subject/3285148/</a>
</li>
</ol>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/trieshu-de-pythonshi-xian.html" class="u-url">Trie树的Python实现</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/trieshu-de-pythonshi-xian.html" rel="bookmark"><time class="published dt-published" datetime="2013-05-21T19:48:53+08:00" title="2013-05-21 19:48">2013-05-21 19:48</time></a></p>
                <p class="commentline">
        
    <a href="posts/trieshu-de-pythonshi-xian.html#disqus_thread" data-disqus-identifier="cache/posts/trieshu-de-pythonshi-xian.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>又是一个由需求驱动的算法学习的例子。</p>
<p>最近<a href="https://github.com/hbprotoss/weibo">weii</a>需要实现一个这样的功能：在发送AT好友的时候能给出自动补全的列表。</p>
<p>最先想到的是当我给出一个用户名的前几个字的时候能自动提示以这个字开头的所有用户名列表（虽然最后发现这是个很2的解决方案-_-），所以最理想的数据结构就是Trie树，也就是字典树。</p>
<p>以前只听过Trie树，现在实际要用了就得把他落到实处了。</p>
<p>首先是<a href="http://zh.wikipedia.org/wiki/Trie">Trie树在维基百科上的定义</a>：在计算机科学中，trie，又称前缀树，是一种有序树，用于保存关联数组，其中的键通常是字符串。与二叉查找树不同，键不是直接保存在节点中，而是由节点在树中的位置决定。一个节点的所有子孙都有相同的前缀，也就是这个节点对应的字符串，而根节点对应空字符串。一般情况下，不是所有的节点都有对应的值，只有叶子节点和部分内部节点所对应的键才有相关的值。</p>
<p>说白了就跟在字典里查单词一样：先拿第一个字母在根节点查找下一结点的位置，如果找到就拿第二个字母在刚刚找到的节点下继续往下查找；如果找不到就说明这个字符串在树中不存在。</p>
<p>C语言实现的代码也在维基百科上：<a href="http://zh.wikipedia.org/wiki/Trie#.E5.AE.9E.E4.BE.8B">http://zh.wikipedia.org/wiki/Trie#.E5.AE.9E.E4.BE.8B</a></p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#define TREE_WIDTH 256</span>

<span class="cp">#define WORDLENMAX 128</span>

<span class="k">struct</span> <span class="n">trie_node_st</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">trie_node_st</span> <span class="o">*</span><span class="n">next</span><span class="p">[</span><span class="n">TREE_WIDTH</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">trie_node_st</span> <span class="n">root</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">}};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">spaces</span><span class="o">=</span><span class="s">" </span><span class="se">\t\n</span><span class="s">/.</span><span class="se">\"\'</span><span class="s">()"</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">insert</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">trie_node_st</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">newnode</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">root</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">[</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">newnode</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">trie_node_st</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trie_node_st</span><span class="p">));</span>
                        <span class="n">memset</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">trie_node_st</span><span class="p">));</span>
                        <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">[</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">=</span> <span class="n">newnode</span><span class="p">;</span>
                <span class="p">}</span> 
                <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">[</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">];</span>
        <span class="p">}</span>
        <span class="n">curr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">++</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">printword</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">do_travel</span><span class="p">(</span><span class="k">struct</span> <span class="n">trie_node_st</span> <span class="o">*</span><span class="n">rootp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">static</span> <span class="kt">char</span> <span class="n">worddump</span><span class="p">[</span><span class="n">WORDLENMAX</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">static</span> <span class="kt">int</span> <span class="n">pos</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rootp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rootp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">worddump</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="sc">'\0'</span><span class="p">;</span>
                <span class="n">printword</span><span class="p">(</span><span class="n">worddump</span><span class="p">,</span> <span class="n">rootp</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">TREE_WIDTH</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">worddump</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
                <span class="n">do_travel</span><span class="p">(</span><span class="n">rootp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="n">pos</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">linebuf</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="o">*</span><span class="n">word</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">ret</span><span class="o">=</span><span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">linebuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">line</span><span class="o">=</span><span class="n">linebuf</span><span class="p">;</span>
                <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">word</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="n">spaces</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">word</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">insert</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>

<span class="cm">/* free(linebuf); */</span>

        <span class="n">do_travel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">);</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre>


<p>但这个版本的实现有两个问题：</p>
<ol>
<li>非常耗内存，一个节点下必须有TREE_WIDTH个子节点，不管子节点代表的字母是否出现在Trie树里。这是非常暴力的哈希。。。</li>
<li>设定了这个TREE_WIDTH也就意味着这个实现只支持ASCII表中的字符作键，不支持中文。</li>
</ol>
<p>Python内置的dict是用哈希实现的，正好可以解决这两个问题。（dict的基本原理可以参考<a href="http://blog.csdn.net/digimon/article/details/7875789">《Python源码剖析》阅读笔记：第五章-dict对象</a>）</p>
<ol>
<li>dict采用的是开放寻址法解决冲突，节省了内存，但时间复杂度还是O(1)。</li>
<li>dict这个哈希表里可以放任意字符作为键，中文当然也不例外。</li>
</ol>
<p>Python版的关键改造就是节点的next表用dict代替，维护的是<code>字符-&gt;子节点</code>的映射。查找时，若待查询字符是next里的一个键就说明该字符在Trie树里，以这个键得到值就能找到下一节点。插入时也只要插入<code>字符-&gt;子节点</code>的映射就可以了。</p>
<p>具体代码在：<a href="https://github.com/hbprotoss/codejam/blob/master/trie.py">https://github.com/hbprotoss/codejam/blob/master/trie.py</a></p>
<pre class="code literal-block"><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="k">class</span> <span class="nc">Trie</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLastNode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">string</span><span class="p">[</span><span class="n">index</span><span class="p">:]:</span>
            <span class="n">new_node</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">node</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_node</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">new_node</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findLastNode</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">findLastNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="sd">'''</span>
<span class="sd">        @param string: string to be searched</span>
<span class="sd">        @return: (index, node).</span>
<span class="sd">            index: int. first char(string[index]) of string not found in Trie tree. Otherwise, the length of string</span>
<span class="sd">            node: dict. node doesn't have string[index].</span>
<span class="sd">        '''</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="n">char</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">printTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span>

        <span class="n">rtns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'.'</span> <span class="o">*</span> <span class="n">layer</span><span class="p">)</span>
            <span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">rtns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">layer</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rtns</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">printTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">Trie</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="s1">''</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
</pre>


<p>全文完。</p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/tong-su-yan-yi-kmp.html" class="u-url">通俗演绎KMP</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/tong-su-yan-yi-kmp.html" rel="bookmark"><time class="published dt-published" datetime="2013-05-07T20:09:38+08:00" title="2013-05-07 20:09">2013-05-07 20:09</time></a></p>
                <p class="commentline">
        
    <a href="posts/tong-su-yan-yi-kmp.html#disqus_thread" data-disqus-identifier="cache/posts/tong-su-yan-yi-kmp.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>最近要实现关键字过滤功能，小看了一些经典的字符串匹配算法。<br>
本文要介绍的是KMP算法（<strong>Knuth–Morris–Pratt Algorithm</strong>）,那个Knuth应该再熟悉不过了。  </p>
<p>KMP算法是从朴素匹配算法改进而来。回忆一下朴素的匹配算法是怎么完成字符串的匹配的呢？<br>
1. 将原串和模式串左对齐，然后一位一位比较，直到有一个字符不匹配<br><img alt="KMP1.png" src="galleries/KMP/KMP1.png" title=""><br>
2. 发现第二位的B和C不匹配，模式串右移一位<br><img alt="KMP2.png" src="galleries/KMP/KMP2.png" title=""><br>
3. 重复这个流程，直到找到完全匹配的子串或者匹配失败。</p>
<p>但这过程中显然有多比较的地方。如，原串为ABCDEABCDF，模式串为ABCDF。第一轮可以发现E和F不匹配<br><img alt="KMP3.png" src="galleries/KMP/KMP3.png" title=""><br>
很显然右移一位必定不匹配，这时模式串可以直接右移4位跳过ABCD，从E开始再次比较<br><img alt="KMP4.png" src="galleries/KMP/KMP4.png" title=""></p>
<p>那是不是跳过的长度就是前面相同部分的长度呢？其实不是这样的，这种直接跳过前面相同部分的做法在某些情况下会有问题。如，原串为ABCDABCDABF，模式串为ABCDABF，直接跳过相同部分就会遗漏匹配的串<br><img alt="KMP5.png" src="galleries/KMP/KMP5.png" title=""><br>
所以跳过的长度并不是前面完全匹配的部分，可以跳过的长度一般存储在模式串的partial match table中，即KMP算法需要对模式串进行预处理。</p>
<p>先来看看这个partial match table在跳过的过程中是怎么用的，然后再来考察计算partial match table的算法。<br>
ABCDABF的partial match table如下：<br><img alt="KMP6.png" src="galleries/KMP/KMP6.png" title=""><br>
可以跳过的长度 = 当前已匹配长度 - 最后一个字母在partial match table中的值。例如：<br><img alt="KMP7.png" src="galleries/KMP/KMP7.png" title=""><br>
当发现C和F不匹配时，根据公式，当前已匹配串ABCDAB长度为6, 最后一个字母B在partial match table中的对应值为2，所以可以跳过的长度 = 6 - 2 = 4，即：<br><img alt="KMP8.png" src="galleries/KMP/KMP8.png" title=""><br>
这样就能正确匹配了。</p>
<p>partial match table中每个位置i记录的其实就是从0到i的子串中，同时出现在子串前缀和后缀中的最大长度。还是以上面那个例子为例：  </p>
<ul>
<li>A没有前缀或后缀，所以长度为0</li>
<li>AB前缀为A，后缀为B，没有相同部分，长度为0</li>
<li>ABC前缀为A、AB，后缀为BC、C，没有相同部分，长度为0</li>
<li>ABCD前缀为A、AB、ABC，后缀为BCD、CD、D，没有相同部分，长度为0</li>
<li>ABCDA前缀为A、AB、ABC、ABCD，后缀为BCDA、CDA、DA、A，相同部分为A，长度为1</li>
<li>ABCDAB前缀为A、AB、ABC、ABCD、ABCDA，后缀为BCDAB、CDAB、DAB、AB、B，相同部分为AB，长度为2</li>
<li>ABCDABF前缀为A、AB、ABC、ABCD、ABCDA、ABCDAB，后缀为BCDABF、BCDAB、CDAB、DAB、AB、B，没有相同部分，长度为0</li>
</ul>
<p>具体代码参考<a href="https://github.com/hbprotoss/codejam/blob/master/kmp.py">https://github.com/hbprotoss/codejam/blob/master/kmp.py</a></p>
<p>全文完。</p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/python-decoratorde-ying-yong.html" class="u-url">Python decorator的应用</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/python-decoratorde-ying-yong.html" rel="bookmark"><time class="published dt-published" datetime="2013-04-03T21:23:39+08:00" title="2013-04-03 21:23">2013-04-03 21:23</time></a></p>
                <p class="commentline">
        
    <a href="posts/python-decoratorde-ying-yong.html#disqus_thread" data-disqus-identifier="cache/posts/python-decoratorde-ying-yong.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>Decorator是23种设计模式之一，提出的目的是为了在不改变现有代码的前提下，通过在头部或尾部添加代码来扩展功能。<br>
Python语言内建支持decorator模式。由于语法不是本文重点，对语法不熟悉的童鞋可以参考以下几篇文章：  </p>
<ol>
<li>Stackoverflow上的神文：<a href="http://stackoverflow.com/a/1594484/837187">Understanding Python decorators</a>
</li>
<li><a href="http://blog.donews.com/limodou/archive/2004/12/19/207521.aspx">[Python学习]decorator的使用</a></li>
<li><a href="http://www.python.org/dev/peps/pep-0318/">PEP318</a></li>
</ol>
<p>下面说一下最近在写SNS客户端插件时Python decorator的应用。<br>
插件的方法完成的任务是：  </p>
<ul>
<li>根据OAuth协议，设置好参数，访问HTTP API</li>
<li>读取服务器返回的json</li>
<li>解析json</li>
</ul>
<p>异常可能来自访问API过程中的网络问题，以及解析json发现服务器返回了错误代码（比如API访问过于频繁，access token有问题等）。在写头几个API的时候做法很自然，用try-except块包裹可能出异常的代码，将各种标准库的异常或者服务器返回的错误信息封装成自己的exception，raise一下告诉主程序有异常需要处理。<br>
但是写了几个方法后发现，每个方法的异常处理流程几乎一模一样，特别是封装标准库的异常，唯一不同的就是解析服务器返回的错误信息。伪码如下：  </p>
<pre class="code literal-block"><span></span>def method(xxx):
    try:
        f = urllib.request.urlopen(url, data, headers)
        raw_data = f.read().decode('utf-8')
        rtn = json.loads(raw_data)
    except Exception1 as e:
        log.error(e)
        raise CustomException1()
    except Exception2 as e:
        log.error(e)
        raise CustomException2()
        xxx
    else:
        return rtn
</pre>


<p>出于懒的原因（说得好听点，出于代码复用的目的:D)，得想个办法把这些重复性的工作提取出来。<br>
仔细观察可以发现，这些方法在except处理完异常之后都没有额外的工作需要进行。换句话说，可以认为这些代码都位于核心处理代码之后，这是自然就想到了decorator模式，将异常处理放在decorator里，再decorate一下各个方法就可以了。<br>
Decorator如下：  </p>
<pre class="code literal-block"><span></span>def sinaMethod(func):
    def func_wrapper(*args, **kwargs):
        try:
            raw_rtn = func(*args, **kwargs)
        except urllib.error.HTTPError as e:
            if e.fp:
                # Sina app error
                error_msg = json.loads(e.fp.read().decode('utf-8'))
                error_code = str(error_msg['error_code'])
                if error_code in exception_dict:
                    raise exception_dict[error_code](error_msg['error'])
                else:
                    raise weiUnknownError(str(e))
            else:
                # Network error
                raise weiNetworkError(str(e))
        else:
            return raw_rtn
    return func_wrapper
</pre>


<p>其作用就是，尝试调用被装饰函数，如果顺利的话直接返回结果。如果有HTTPError异常发生，则解析之，并根据相应情况封装成自定义的异常抛出。<br>
这里使得代码比较简短的一个关键就是这个exception_dict，里面维护了新浪错误代码和需要抛出的异常类之间的映射。根据返回的error_code查找这个字典，如果有则说明这是我们需要关心的异常，那么就用错误消息构造异常对象抛出。如果没有，就不是需要关心的异常，以weiUnknownError异常抛出。<br>
由于新浪在出错时除了返回HTTP报头，还有一段附加data，所以如果e.fp为None则说明不是应用层的异常，可能是网络层及以下出了问题，抛出weiNetworkError。  </p>
<p>使用就很简单了，在被装饰的函数前一行加<code>@sinaMethod</code>就可以了。<br>
就这么简单~~  </p>
<hr>
<p>PS：附带说一句，编程语言对设计模式在语法上的支持会大大简化程序猿的编码量。如果是C++/Java，甚至C要用decorator模式就得协商老长一段了~~^_^</p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/multipartform-datade-shi-xian.html" class="u-url">multipart/form-data的实现</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/multipartform-datade-shi-xian.html" rel="bookmark"><time class="published dt-published" datetime="2013-03-29T09:19:39+08:00" title="2013-03-29 09:19">2013-03-29 09:19</time></a></p>
                <p class="commentline">
        
    <a href="posts/multipartform-datade-shi-xian.html#disqus_thread" data-disqus-identifier="cache/posts/multipartform-datade-shi-xian.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>写之前先吐槽几句：Python社区太懒了，Python3都推出多少年了，那么多第三方库还不port到Python3。不能安于现状啊！  </p>
<hr>
<p>下面是正题：</p>
<p>最近写微博客户端，上传图片需要multipart/form-data编码图片和参数，由于前面说的原因，没有第三方库可用，所以就自己实现一下。</p>
<p>先贴一下multipart/form-data的RFC文档地址：<a href="http://www.ietf.org/rfc/rfc2388.txt">点这里</a></p>
<p>multipart/form-data主要由三部分组成：  </p>
<ol>
<li>HTTP Header。需要添加头"Content-Type: multipart/form-data; boundary=%s"，这个boundary就是分隔符，见第二条。</li>
<li>分隔符boundary。分隔符是一串和正文内容不冲突的字符串，用以分割多个参数。一般都是N个减号+随机字符串，比如"----------当前时间"。<br>
   正文需要加header：<br>
   Content-Disposition: form-data; name="%s"，%s为需要传递的变量名。<br>
   Content-Type: 指定正文MIME类型，默认是纯文本text/plain，未知类型可以填application/octet-stream。  </li>
<li>数据。要注意的是数据的编码，文档上说"7BIT encoding"，ISO-8859-1即可。</li>
</ol>
<p>下面贴一段上传新浪微博图片的代码：  </p>
<table class="codehilitetable"><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td>
<td class="code">
<pre class="code literal-block"><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib.error</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>

<span class="k">def</span> <span class="nf">_encode_multipart</span><span class="p">(</span><span class="n">params_dict</span><span class="p">):</span>
    <span class="sd">'''</span>
<span class="sd">    Build a multipart/form-data body with generated random boundary.</span>
<span class="sd">    '''</span>
    <span class="n">boundary</span> <span class="o">=</span> <span class="s1">'----------</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'--</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">'read'</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">decoded_content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'ISO-8859-1'</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Content-Disposition: form-data; name="</span><span class="si">%s</span><span class="s1">"; filename="hidden"'</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Content-Type: application/octet-stream</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decoded_content</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'Content-Disposition: form-data; name="</span><span class="si">%s</span><span class="s1">"</span><span class="se">\r\n</span><span class="s1">'</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'--</span><span class="si">%s</span><span class="s1">--</span><span class="se">\r\n</span><span class="s1">'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">boundary</span>

<span class="c1">#############################################################</span>
<span class="n">url</span> <span class="o">=</span> <span class="s1">'https://upload.api.weibo.com/2/statuses/upload.json'</span>
<span class="n">access_token</span> <span class="o">=</span> <span class="s1">'xxx'</span>
<span class="n">file_name</span> <span class="o">=</span> <span class="s1">'big.png'</span>
<span class="n">path</span> <span class="o">=</span> <span class="s1">'/home/xxx/Downloads/'</span> <span class="o">+</span> <span class="n">file_name</span>
<span class="n">status</span> <span class="o">=</span> <span class="s1">'1234567'</span>

<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'access_token'</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
    <span class="s1">'status'</span><span class="p">:</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
    <span class="s1">'pic'</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">coded_params</span><span class="p">,</span> <span class="n">boundary</span> <span class="o">=</span> <span class="n">_encode_multipart</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

<span class="c1">#############################################################</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">coded_params</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'ISO-8859-1'</span><span class="p">))</span>
<span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">'Content-Type'</span><span class="p">,</span> <span class="s1">'multipart/form-data; boundary=</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">boundary</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre>
</td>
</tr></table>
<p><strong>其中尤其要注意的是，POST上去的data部分要encode成ISO-8859-1。一开始一直encode成UTF-8，死活报的都是格式错误。</strong></p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/nikolagitpageda-jian-bo-ke.html" class="u-url">nikola+gitpage搭建博客</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/nikolagitpageda-jian-bo-ke.html" rel="bookmark"><time class="published dt-published" datetime="2013-03-18T19:46:37+08:00" title="2013-03-18 19:46">2013-03-18 19:46</time></a></p>
                <p class="commentline">
        
    <a href="posts/nikolagitpageda-jian-bo-ke.html#disqus_thread" data-disqus-identifier="cache/posts/nikolagitpageda-jian-bo-ke.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>本来博客是在CSDN上的<a href="http://blog.csdn.net/digimon">http://blog.csdn.net/digimon</a>，但最近CSDN在我这一直无法登录，已经在Evernote上积压了好几篇博客，搞烦了，决定自己搭个博客。<br>
由于目前是没有收入来源的屌丝，没钱去买个域名、弄个VPS，只能想免费的招了。WordPress这货屏蔽GAE的UA，导致没法申请博客，最后想到了gitpage。虽然gitpage也有随时被墙的风险，但是我的博客主要记录技术内容，作为程序猿翻个伟大的防火墙还是没问题的吧;-)  </p>
<p>gitpage只支持静态页面，网上搜了一下，生成静态页面的工具还真不少，好像专门为此设计的一样，套餐呐有木有。<br>
Python的就有不少: <a href="http://www.quora.com/Whats-the-best-available-static-blog-website-generator-in-Python">What's the best available static blog/website generator in Python?</a><br>
还有更多别的语言支持的工具: <a href="https://iwantmyname.com/blog/2011/02/list-static-website-generators.html">32 Static Website Generators For Your Site, Blog Or Wiki</a>  </p>
<p>最终选择了nikola，也是因为Quora上那篇文章的推荐。<br>
nikola官网：<a href="http://nikola.ralsina.com.ar/">http://nikola.ralsina.com.ar/</a>  </p>
<p>详细安装和配置的教程就不赘述了，可以参考这两篇文章：<br>
+ <a href="http://nikola.ralsina.com.ar/handbook.html">The Nikola Handbook</a>（官网教程）<br>
+ <a href="http://rca.is-programmer.com/2013/2/5/using-nikola-write-static-blog.37513.html">用 nikola 写静态博客</a>  </p>
<p>下面说一下安装和配置nikola时要注意的问题。<br>
1.  官网上的<a href="http://nikola.ralsina.com.ar/handbook.html#installing-nikola">安装指导</a>中，如果你是Ubuntu用户的话，<a href="http://makotemplates.org/">Mako</a>一定要用pip安装或自己去下，Ubuntu官方源上的版本太旧，运行会出问题。<br>
2.  喜欢用markdown的童鞋除了更改nikola生成的站点根目录下的从conf.py之外，新建博文的时候要注意加上<code>-f markdown</code>参数：<code>nikola new_post -f markdown</code><br>
3.  喜欢用markdown的童鞋还得<strong>注意</strong>一下(==!)，官方0.5.4有个bug。在<code>/usr/local/lib/python2.7/dist-packages/nikola/plugins/compile_markdown/__init__.py</code>文件中，在73~81行的字符串前加个字母u。  </p>
<pre class="code literal-block"><span></span>    with codecs.open(path, "wb+", "utf8") as fd:
        if onefile:
            fd.write('&lt;!-- \n')
            fd.write('.. title: {0}\n'.format(title))
            fd.write('.. slug: {0}\n'.format(slug))
            fd.write('.. date: {0}\n'.format(date))
            fd.write('.. tags: {0}\n'.format(tags))
            fd.write('.. link: \n')
            fd.write('.. description: \n')
            fd.write('--&gt;\n\n')
        fd.write("\nWrite your post here.")
</pre>


<p>改成  </p>
<pre class="code literal-block"><span></span>    with codecs.open(path, "wb+", "utf8") as fd:
        if onefile:
            fd.write(u'&lt;!-- \n')
            fd.write(u'.. title: {0}\n'.format(title))
            fd.write(u'.. slug: {0}\n'.format(slug))
            fd.write(u'.. date: {0}\n'.format(date))
            fd.write(u'.. tags: {0}\n'.format(tags))
            fd.write(u'.. link: \n')
            fd.write(u'.. description: \n')
            fd.write(u'--&gt;\n\n')
        fd.write(u"\nWrite your post here.")
</pre>


<p>因为不加u就是str对象，写入的是utf-8编码的文件，当title等参数里出现非英文字母的时候会出先解码异常。（马上提交个pull request去）<br>
4. 要快速部署到gitpage，在站点conf.py里添加：</p>
<pre class="code literal-block"><span></span>DEPLOY_COMMANDS = [
'git --git-dir=output/.git --work-tree=output add -A ',
'git --git-dir=output/.git --work-tree=output commit -m "latest auto deploy build"',
'git --git-dir=output/.git --work-tree=output push origin master'
]
</pre>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/pythonde-importji-zhi.html" class="u-url">python的import机制</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/pythonde-importji-zhi.html" rel="bookmark"><time class="published dt-published" datetime="2013-03-18T19:11:42+08:00" title="2013-03-18 19:11">2013-03-18 19:11</time></a></p>
                <p class="commentline">
        
    <a href="posts/pythonde-importji-zhi.html#disqus_thread" data-disqus-identifier="cache/posts/pythonde-importji-zhi.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>同一个模块以相同的模块名被导入时，模块内的代码只执行一遍（模块名必须相同）。<br>
例：  </p>
<blockquote>
<p>import/<br>
    test.py<br>
    mo/<br>
        A.py  </p>
</blockquote>
<hr>
<pre class="code literal-block"><span></span># A.py
a = 1
print(a)
a += 1
</pre>


<hr>
<pre class="code literal-block"><span></span><span class="c1"># test.py</span>
<span class="c1">#!/usr/bin/env python3</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">mo.A</span>
<span class="kn">import</span> <span class="nn">mo.A</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">'./mo'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">A</span>
</pre>


<hr>
<p>test.py中，第4行执行后输出1。第5行不输出，因为mo.A已经被导入当前namespace。  </p>
<p>但是第9行，虽然都是同一个物理文件A.py，但是被导入时的名字不同（mo.A和A），所以还是会输出1。mo.A和A作为两个独立的module对象存在当前namespace中。  </p>
<p>如果要把模块中的变量当全局变量来使用的话，一定要从项目顶部通过“.”一层一层import。  </p>
</div>
    </div>
    </article><article class="blog-post h-entry post-text"><header><h2 class="p-name entry-title blog-post-title"><a href="posts/shi-xian-jian-dan-xian-cheng-chi.html" class="u-url">实现简单线程池</a></h2>
        <div class="metadata blog-post-meta">
            <p class="byline author vcard"><span class="byline-name fn">hbprotoss</span></p>
            <p class="dateline"><a href="posts/shi-xian-jian-dan-xian-cheng-chi.html" rel="bookmark"><time class="published dt-published" datetime="2013-03-18T18:28:37+08:00" title="2013-03-18 18:28">2013-03-18 18:28</time></a></p>
                <p class="commentline">
        
    <a href="posts/shi-xian-jian-dan-xian-cheng-chi.html#disqus_thread" data-disqus-identifier="cache/posts/shi-xian-jian-dan-xian-cheng-chi.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<p>前段时间在写代码的时候（用了Qt）出现了似乎跟线程池有关的bug，在不确定是否是Qt线程池库QThreadPool的bug的情况下，自己实现了一个简单的线程池以确定到底是我的问题还是QThreadPool是否真有bug。（剧透下，最后证明不是QThreadPool有问题，可能是信号在线程之间传递的时候有问题，这个bug至今未修复= =）  </p>
<p>下面记录下我这个线程池的实现思路。<br>
主要有两个类，Thread、Manager。ThreadPool类是整体的包装。  </p>
<p>Thread，继承自QThread，用来执行线程代码，并且作为线程对象存在。<br>
Manager，当前线程活动情况的管理类，检查线程池内空闲线程的情况，并管理新添加的任务。  </p>
<h3><strong>Manager</strong></h3>
<p>Manager内部有一个维护空闲线程对象的集合idle_thread，考虑到需要在O(1)的时间内添加或删除指定元素，用了python内置的set。set内部使用哈希实现的，所以时间效率基本能控制在O(1)左右。<br>
还有一个已添加任务的队列queue。时间效率上，入队和出队都要求O(1)的时间，但是最先想到的python内置的list对象是数组和链表的结合，入队时间是O(1)，出队时间却是O(n)（参见<a href="http://blog.csdn.net/digimon/article/details/7875781">这个链接</a>），所以用了collections.deque，一个双向链表，能实现入队和出队都是O(1)的时间。另外，由于我不需要优先级的概念，所以线性表足矣。以后如果要考虑优先级的话会改成堆。<br>
另外就是一个idle_thread的互斥量mutex。因为set对象是线程不安全的，所以在添加和删除元素的时候必须有互斥量保护。而collections.deque文档上说是线程安全的，所以就不需要互斥量之类的机制了。  </p>
<p>Manager的接口有：<br>
hasIdleThread，返回线程池内是否还有空闲线程。<br>
setThreadIdle，将某个线程加入到空闲线程池中。<br>
startTask，先将task入队，然后看是否有空闲线程，如果有则在这个空闲线程上执行，没有的话就留在队列里等待下次调度。  </p>
<h3><strong>Thread</strong></h3>
<p>在run方法内，通过Manager取出一个task执行，循环直到再没有新的task为止，之后跳出循环，将自己加入到空闲线程集合内。<br>
其实这样并不能保证线程一直存活，还是会有销毁和重建线程的动作，而且某些极端情况下还会很频繁。但是我当时的情况是要执行的任务会一次性全部加入到队列里，而下一次同样的添加动作会相隔比较长的时间，所以问题不大。更重要的是，当时只是为了确定QThreadPool是否有bug，这方面没有考虑地太多。  </p>
<p>下面是具体代码（遵循GPLv3协议）  </p>
<table class="codehilitetable"><tr>
<td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre></div></td>
<td class="code">
<pre class="code literal-block"><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">PyQt4.QtCore</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="k">import</span> <span class="n">logger</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Thread</span><span class="p">(</span><span class="n">QThread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Thread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">queue</span><span class="p">))</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">dequeueTask</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">autoDelete</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">task</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># There is no task</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">'No task, </span><span class="si">%s</span><span class="s1"> quiting'</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">setThreadIdle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Manager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_thread_count</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_thread_count</span> <span class="o">=</span> <span class="n">max_thread_count</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">Thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'thread_</span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_thread_count</span><span class="p">)]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads_mutex</span> <span class="o">=</span> <span class="n">QMutex</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">hasIdleThread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_threads</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">setThreadIdle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads_mutex</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1"> becomes idle'</span> <span class="o">%</span> <span class="n">thread</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads_mutex</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">startTask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1"> enqueued'</span> <span class="o">%</span> <span class="n">task</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads_mutex</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1"> started'</span> <span class="o">%</span> <span class="n">task</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># No idle thread</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'No idle thread'</span><span class="p">)</span>
        <span class="k">pass</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">idle_threads_mutex</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">enqueueTask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dequeueTask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ThreadPool</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_thread_count</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">max_thread_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">QRunnable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">'Task must be QRunnable object.'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">startTask</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</pre>
</td>
</tr></table>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2.html" rel="prev">Newer posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="hbprotoss";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
            <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
                    <div class="sidebar-module sidebar-module-inset">
      <h4>About</h4>
      <p>踏歌长行</p>
      <p>梦想永在</p>
    </div>
    
            </div>
        <!--End of body content-->
        </div>
    </div>
</div>

<footer class="blog-footer" id="footer"><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-nd/3.0/88x31.png"></a><br>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">知识共享署名-非商业性使用-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。
<br>Contents © 2018 <a href="mailto:">hbprotoss</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
    
</footer><script src="assets/js/jquery.min.js"></script><script src="assets/js/bootstrap.min.js"></script><script src="assets/js/moment-with-locales.min.js"></script><script src="assets/js/fancydates.js"></script><script src="assets/js/jquery.colorbox-min.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
